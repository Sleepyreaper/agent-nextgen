{% extends "base.html" %}

{% block title %}Student Dashboard - {{ summary.name }}{% endblock %}

{% block extra_css %}
<style>
    body { background: #f4f7fa; }
    .dashboard-container { max-width: 1100px; margin: 2rem auto; padding: 2rem; background: #fff; border-radius: 14px; box-shadow: 0 2px 16px rgba(0,0,0,0.07); }
    .dashboard-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem; }
    .student-info { flex: 1; }
    .student-info h1 { font-size: 2.5rem; margin-bottom: 0.3rem; color: #1e293b; }
    .student-info p { color: #475569; margin-bottom: 0.2rem; }
    .dashboard-badges { text-align: right; }
    .badge { display: inline-block; padding: 0.4rem 0.9rem; border-radius: 4px; font-size: 0.95rem; font-weight: 500; margin-left: 0.5rem; }
    .badge-training { background: #dbeafe; color: #1e40af; }
    .badge-selected { background: #d1fae5; color: #065f46; }
    .dashboard-stats { display: flex; gap: 2rem; margin-bottom: 2.5rem; }
    .stat-card { flex: 1; background: #f1f5f9; border-radius: 10px; padding: 1.5rem; text-align: center; box-shadow: 0 1px 4px rgba(0,0,0,0.03); }
    .stat-value { font-size: 2.2rem; font-weight: bold; color: #0f172a; }
    .stat-label { color: #64748b; font-size: 1rem; margin-top: 0.5rem; }
    .section { margin-bottom: 2.5rem; }
    .section-title { font-size: 1.4rem; color: #334155; border-bottom: 2px solid #38bdf8; padding-bottom: 0.4rem; margin-bottom: 1.2rem; }
    .agent-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem; }
    .agent-card { background: #f8fafc; border-radius: 10px; box-shadow: 0 1px 4px rgba(0,0,0,0.04); padding: 1.2rem 1.5rem; }
    .agent-card h3 { margin-top: 0; color: #2563eb; font-size: 1.15rem; margin-bottom: 0.7rem; }
    .agent-summary { color: #334155; font-size: 1.05rem; margin-bottom: 0.7rem; }
    .agent-details { color: #64748b; font-size: 0.98rem; }
    .score-badge { display: inline-block; background: #38bdf8; color: #fff; border-radius: 4px; padding: 0.2rem 0.7rem; font-size: 1.1rem; font-weight: 600; margin-left: 0.5rem; }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <div class="student-info">
            <h1>{{ summary.name }}</h1>
            <p>ðŸ“§ {{ summary.email }}</p>
            <p>ðŸ“… Uploaded: {{ summary.uploaded_date.strftime('%B %d, %Y') if summary.uploaded_date else 'Unknown' }}</p>
        </div>
        <div class="dashboard-badges">
            {% if summary.is_training %}
                <span class="badge badge-training">Training Data</span>
            {% endif %}
            {% if summary.was_selected %}
                <span class="badge badge-selected">Selected</span>
            {% endif %}
        </div>
    </div>
    <div class="dashboard-stats">
        <div class="stat-card">
            <div class="stat-value">{{ summary['word_count'] if summary is defined and 'word_count' in summary and summary['word_count'] else 'N/A' }}</div>
            <div class="stat-label">Words</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ summary['file_name'].split('.')[-1].upper() if summary is defined and 'file_name' in summary and summary['file_name'] else 'TXT' }}</div>
            <div class="stat-label">File Type</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ 'Yes' if evaluation is defined and evaluation else 'No' }}</div>
            <div class="stat-label">Evaluated</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ agent_results.merlin.overall_score if agent_results and agent_results.merlin and agent_results.merlin.overall_score else 'N/A' }}</div>
            <div class="stat-label">Overall Score</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ agent_results.merlin.match_score if agent_results and agent_results.merlin and agent_results.merlin.match_score is not none else 'N/A' }}</div>
            <div class="stat-label">Match Score</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ alignment_score if alignment_score is not none else 'N/A' }}</div>
            <div class="stat-label">NextGen Align</div>
        </div>
    </div>

    <div class="section">
        <div class="section-title">Executive Summary</div>
        {% set merlin = agent_results.get('merlin') if agent_results else None %}
        {% set aurora = agent_results.get('aurora') if agent_results else None %}
        {% set merlin_summary = None %}
        {% set aurora_summary = None %}
        {% if merlin %}
            {% if merlin.human_summary %}
                {% set merlin_summary = merlin.human_summary %}
            {% elif merlin.summary %}
                {% set merlin_summary = merlin.summary %}
            {% endif %}
        {% endif %}
        {% if aurora %}
            {% if aurora.human_summary %}
                {% set aurora_summary = aurora.human_summary %}
            {% elif aurora.summary %}
                {% set aurora_summary = aurora.summary %}
            {% endif %}
        {% endif %}
        {% set exec_summary = None %}
        {% if merlin_summary and aurora_summary %}
            {% set exec_summary = aurora_summary ~ '\n---\n' ~ merlin_summary %}
        {% elif aurora_summary %}
            {% set exec_summary = aurora_summary %}
        {% elif merlin_summary %}
            {% set exec_summary = merlin_summary %}
        {% elif summary and summary.human_summary %}
            {% set exec_summary = summary.human_summary %}
        {% endif %}
        {% if exec_summary %}
            <div class="agent-summary" style="font-size:1.25rem; font-style:italic; background:#f1f5f9; border-radius:8px; padding:1.2rem; margin-bottom:1.5rem; border-left:4px solid #38bdf8; color:#334155;">
                {{ exec_summary | replace('\n', '<br>') | safe }}
            </div>
        {% else %}
            <div class="agent-summary">No summary available.</div>
        {% endif %}
    </div>

    <div class="section">
        <div class="section-title">Agent Insights</div>
        <div class="agent-cards">
            {% for agent_id, agent in agent_results.items() %}
                {% if agent.human_summary %}
                <div class="agent-card">
                    <h3>{{ agent_id|capitalize }} {% if agent.overall_score %}<span class="score-badge">{{ agent.overall_score }}</span>{% endif %}</h3>
                    <div class="agent-summary">{{ agent.human_summary }}</div>
                    <div class="agent-details">
                        {% if agent.key_strengths %}
                            <strong>Strengths:</strong> {{ agent.key_strengths }}<br>
                        {% endif %}
                        {% if agent.key_risks %}
                            <strong>Risks:</strong> {{ agent.key_risks }}<br>
                        {% endif %}
                        {% if agent.recommendation %}
                            <strong>Recommendation:</strong> {{ agent.recommendation }}<br>
                        {% endif %}
                        {% if agent.confidence %}
                            <strong>Confidence:</strong> {{ agent.confidence }}<br>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <div class="section">
        <div class="section-title">Milo Training Insights</div>
        {% if milo_insights and milo_insights.status == 'success' %}
            {% if milo_insights.summary %}
                <p><strong>Summary:</strong> {{ milo_insights.summary }}</p>
            {% endif %}
            {% if milo_insights.differentiators %}
                <strong>Differentiators:</strong>
                <ul>
                    {% for item in milo_insights.differentiators %}
                        <li>{{ item }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
            {% if milo_insights.average_merlin_score is defined %}
                <p><em>Average Merlin score for training set: {{ milo_insights.average_merlin_score }}</em></p>
            {% endif %}
        {% else %}
            <p>Insights unavailable.</p>
        {% endif %}

        {% if milo_alignment and milo_alignment.status == 'success' %}
            <div style="margin-top:1rem; padding:1rem; background:#f0fdf4; border-left:4px solid #10b981;">
                <h4 style="margin:0 0 0.5rem 0; color:#065f46;">AI Alignment Analysis</h4>
                {% if milo_alignment.match_score is defined %}
                    <p><strong>Match score:</strong> {{ milo_alignment.match_score }} / 100</p>
                {% endif %}
                {% if milo_alignment.nextgen_align_score is defined %}
                    <p><strong>NextGen align score:</strong> {{ milo_alignment.nextgen_align_score }} / 100</p>
                {% endif %}
                {% if milo_alignment.explanation %}
                    <p><em>{{ milo_alignment.explanation }}</em></p>
                {% endif %}
            </div>
        {% endif %}
    </div>

    <div class="section">
        <div class="section-title">Application Content</div>
        <div style="background: #f1f5f9; padding: 1.2rem; border-radius: 8px;">
            <p style="white-space: pre-wrap; color: #334155;">{{ summary.text_preview }}</p>
            {% if summary is defined and 'word_count' in summary and summary['word_count'] > 250 %}
                <p style="color: #64748b; font-size: 0.95rem; margin-top: 1rem; font-style: italic;">... [{{ summary['word_count'] - 250 }} more words]</p>
            {% endif %}
        </div>
    </div>

    <div class="section">
        <div class="section-title">Full Agent Data (Advanced)</div>
        <pre style="background: #f8fafc; color: #64748b; padding: 1rem; border-radius: 8px; font-size: 0.97rem; overflow-x: auto;">{{ agent_results | tojson(indent=2) }}</pre>
    </div>
</div>
{% endblock %}
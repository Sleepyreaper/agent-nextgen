{% extends "base.html" %}

{% block title %}Student Dashboard - {{ summary.name }}{% endblock %}

{% block extra_css %}
<style>
    body { background: #f4f7fa; }
    .dashboard-container { max-width: 1100px; margin: 2rem auto; padding: 2rem; background: #fff; border-radius: 14px; box-shadow: 0 2px 16px rgba(0,0,0,0.07); }
    .dashboard-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem; }
    .student-info { flex: 1; }
    .student-info h1 { font-size: 2.5rem; margin-bottom: 0.3rem; color: #1e293b; }
    .student-info p { color: #475569; margin-bottom: 0.2rem; }
    .dashboard-badges { text-align: right; }
    .badge { display: inline-block; padding: 0.4rem 0.9rem; border-radius: 4px; font-size: 0.95rem; font-weight: 500; margin-left: 0.5rem; }
    .badge-training { background: #dbeafe; color: #1e40af; }
    .badge-selected { background: #d1fae5; color: #065f46; }
    .dashboard-stats { display: flex; gap: 2rem; margin-bottom: 2.5rem; }
    .stat-card { flex: 1; background: #f1f5f9; border-radius: 10px; padding: 1.5rem; text-align: center; box-shadow: 0 1px 4px rgba(0,0,0,0.03); }
    .stat-value { font-size: 2.2rem; font-weight: bold; color: #0f172a; }
    .stat-label { color: #64748b; font-size: 1rem; margin-top: 0.5rem; }
    .section { margin-bottom: 2.5rem; }
    .section-title { font-size: 1.4rem; color: #334155; border-bottom: 2px solid #38bdf8; padding-bottom: 0.4rem; margin-bottom: 1.2rem; }
    .agent-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem; }
    .agent-card { background: #f8fafc; border-radius: 10px; box-shadow: 0 1px 4px rgba(0,0,0,0.04); padding: 1.2rem 1.5rem; }
    .agent-card h3 { margin-top: 0; color: #2563eb; font-size: 1.15rem; margin-bottom: 0.7rem; }
    .agent-summary { color: #334155; font-size: 1.05rem; margin-bottom: 0.7rem; }
    .agent-details { color: #64748b; font-size: 0.98rem; }
    .score-badge { display: inline-block; background: #38bdf8; color: #fff; border-radius: 4px; padding: 0.2rem 0.7rem; font-size: 1.1rem; font-weight: 600; margin-left: 0.5rem; }
</style>
{% endblock %}

{# â”€â”€ Resolve each agent explicitly so stale/unknown keys never leak through â”€â”€ #}
{% set merlin  = agent_results.get('merlin')  if agent_results else None %}
{% set aurora  = agent_results.get('aurora')  if agent_results else None %}
{% set tiana   = agent_results.get('tiana')   if agent_results else None %}
{% set rapunzel = agent_results.get('rapunzel') if agent_results else None %}
{% set mulan   = agent_results.get('mulan')   if agent_results else None %}
{% set moana   = agent_results.get('moana')   if agent_results else None %}

{% block content %}
<div class="dashboard-container">
    {# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  HEADER  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• #}
    <div class="dashboard-header">
        <div class="student-info">
            <h1>{{ summary.name }}</h1>
            <p style="color: #64748b; font-size: 0.95rem; margin-bottom: 0.5rem;">Student evaluation dashboard â€” scores, agent results, and assessment details</p>
            <p>ğŸ“§ {{ summary.email }}</p>
            <p>ğŸ“… Uploaded: {{ summary.uploaded_date.strftime('%B %d, %Y') if summary.uploaded_date else 'Unknown' }}</p>
        </div>
        <div class="dashboard-badges">
            {% if summary.is_training %}
                <span class="badge badge-training">Training Data</span>
            {% endif %}
            {% if summary.was_selected %}
                <span class="badge badge-selected">Selected</span>
            {% endif %}
        </div>
    </div>

    {# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  SCORE CARDS  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• #}
    <div class="dashboard-stats">
        <div class="stat-card" style="{% if nextgen_match is defined and nextgen_match is not none %}{% if nextgen_match >= 60 %}background:linear-gradient(135deg,#d1fae5,#a7f3d0); border:2px solid #10b981;{% elif nextgen_match >= 30 %}background:linear-gradient(135deg,#fef9c3,#fde68a); border:2px solid #f59e0b;{% else %}background:linear-gradient(135deg,#fee2e2,#fecaca); border:2px solid #ef4444;{% endif %}{% endif %}">
            <div class="stat-value" style="font-size:2.6rem;">
                {% if nextgen_match is defined and nextgen_match is not none %}
                    {{ nextgen_match }}%
                {% else %}
                    N/A
                {% endif %}
            </div>
            <div class="stat-label" style="font-weight:600; font-size:1.1rem;">Next Gen Match</div>
            <div style="font-size:0.8rem; color:#64748b; margin-top:0.3rem;">~30 spots / 1,000+ applicants</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ merlin.overall_score if merlin and merlin.overall_score else 'N/A' }}</div>
            <div class="stat-label">Overall Score</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ merlin.recommendation if merlin and merlin.recommendation else 'N/A' }}</div>
            <div class="stat-label">Recommendation</div>
        </div>
    </div>

    {# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  MERLIN EXECUTIVE SUMMARY  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• #}
    <div class="section">
        <div class="section-title">ğŸ§™ Merlin Executive Summary</div>
        {% set merlin_text = None %}
        {% if merlin %}
            {% if merlin.human_summary %}
                {% set merlin_text = merlin.human_summary %}
            {% elif merlin.executive_summary %}
                {% set merlin_text = merlin.executive_summary %}
            {% elif merlin.rationale %}
                {% set merlin_text = merlin.rationale %}
            {% elif merlin.summary %}
                {% set merlin_text = merlin.summary %}
            {% endif %}
        {% endif %}
        {% if merlin_text %}
            <div style="font-size:1.15rem; background:#f1f5f9; border-radius:8px; padding:1.2rem; border-left:4px solid #6366f1; color:#334155; line-height:1.7;">
                {{ merlin_text | replace('\n', '<br>') | safe }}
            </div>
            {% if merlin and merlin.confidence %}
            <div style="margin-top:0.5rem; color:#64748b; font-size:0.9rem;">
                <strong>Confidence:</strong> {{ merlin.confidence }}
                {% if merlin.key_strengths %} Â· <strong>Strengths:</strong> {{ merlin.key_strengths }}{% endif %}
                {% if merlin.key_risks %} Â· <strong>Risks:</strong> {{ merlin.key_risks }}{% endif %}
            </div>
            {% endif %}
        {% else %}
            <div class="agent-summary" style="color:#94a3b8;">Merlin has not evaluated this student yet.</div>
        {% endif %}
    </div>

    {# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  AGENT SUMMARIES  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• #}
    <div class="section">
        <div class="section-title">Agent Summaries</div>
        <div class="agent-cards">

            {# â”€â”€ Tiana (Application/Essay Reader) â”€â”€ #}
            {% if tiana and (tiana.human_summary or tiana.essay_summary or tiana.essaysummary) %}
            <div class="agent-card">
                <h3>ğŸ‘¸ Tiana {% if tiana.readiness_score or tiana.readinessscore %}<span class="score-badge">{{ tiana.readiness_score or tiana.readinessscore }}</span>{% endif %}</h3>
                <div class="agent-summary">{{ tiana.human_summary or tiana.essay_summary or tiana.essaysummary }}</div>
            </div>
            {% endif %}

            {# â”€â”€ Rapunzel (Grade Reader) â”€â”€ #}
            {% if rapunzel and (rapunzel.human_summary or rapunzel.summary) %}
            <div class="agent-card">
                <h3>ğŸ’‡ Rapunzel {% if rapunzel.gpa %}<span class="score-badge">GPA: {{ rapunzel.gpa }}</span>{% endif %}</h3>
                <div class="agent-summary">{{ rapunzel.human_summary or rapunzel.summary }}</div>
                <div class="agent-details">
                    {% if rapunzel.academic_strength %}<strong>Academic Strength:</strong> {{ rapunzel.academic_strength }}<br>{% endif %}
                    {% if rapunzel.course_rigor_index %}<strong>Course Rigor:</strong> {{ rapunzel.course_rigor_index }}<br>{% endif %}
                </div>
            </div>
            {% endif %}

            {# â”€â”€ Mulan (Recommendation Reader) â”€â”€ #}
            {% if mulan %}
                {% if mulan is mapping and (mulan.human_summary or mulan.summary) %}
                <div class="agent-card">
                    <h3>ğŸ—¡ï¸ Mulan {% if mulan.endorsement_strength or mulan.endorsementstrength %}<span class="score-badge">{{ mulan.endorsement_strength or mulan.endorsementstrength }}/100</span>{% endif %}</h3>
                    <div class="agent-summary">{{ mulan.human_summary or mulan.summary }}</div>
                </div>
                {% elif mulan is sequence and mulan | length > 0 %}
                <div class="agent-card">
                    <h3>ğŸ—¡ï¸ Mulan <span class="score-badge">{{ mulan | length }} rec{{ 's' if mulan | length > 1 }}</span></h3>
                    {% for rec in mulan %}
                    <div class="agent-summary" style="{% if not loop.last %}border-bottom:1px solid #e2e8f0; padding-bottom:0.5rem; margin-bottom:0.5rem;{% endif %}">
                        <strong>{{ rec.recommender_name or rec.recommendername or 'Recommender' }}</strong>
                        {% if rec.recommender_role or rec.recommenderrole %}<span style="color:#64748b;"> ({{ rec.recommender_role or rec.recommenderrole }})</span>{% endif %}
                        {% if rec.endorsement_strength or rec.endorsementstrength %} Â· Strength: {{ rec.endorsement_strength or rec.endorsementstrength }}/100{% endif %}
                        {% if rec.summary %}<br>{{ rec.summary }}{% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            {% endif %}

            {# â”€â”€ Moana (School Context) â”€â”€ #}
            {% if moana and (moana.human_summary or moana.comparison_notes or moana.comparisonnotes or moana.context) %}
            <div class="agent-card">
                <h3>ğŸŒŠ Moana</h3>
                <div class="agent-summary">{{ moana.human_summary or moana.comparison_notes or moana.comparisonnotes or moana.context }}</div>
            </div>
            {% endif %}

            {# â”€â”€ Aurora (Report Formatter) â”€â”€ #}
            {% if aurora and aurora.human_summary %}
            <div class="agent-card">
                <h3>ğŸŒ… Aurora</h3>
                <div class="agent-summary">{{ aurora.human_summary }}</div>
            </div>
            {% endif %}

        </div>
    </div>

    {# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  MILO TRAINING INSIGHTS  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• #}
    <div class="section">
        <div class="section-title">ğŸ“Š Milo Training Insights</div>
        {% if milo_insights and milo_insights.status == 'success' %}
            {% if milo_insights.summary %}
                <p><strong>Summary:</strong> {{ milo_insights.summary }}</p>
            {% endif %}
            {% if milo_insights.differentiators %}
                <strong>Differentiators:</strong>
                <ul>
                    {% for item in milo_insights.differentiators %}
                        <li>{{ item }}</li>
                    {% endfor %}
                </ul>
            {% endif %}
            {% if milo_insights.average_merlin_score is defined %}
                <p><em>Average Merlin score for training set: {{ milo_insights.average_merlin_score }}</em></p>
            {% endif %}
        {% else %}
            <p>Insights unavailable.</p>
        {% endif %}

        {% if milo_alignment and milo_alignment.status == 'success' %}
            <div style="margin-top:1rem; padding:1rem; background:#f0fdf4; border-left:4px solid #10b981;">
                <h4 style="margin:0 0 0.5rem 0; color:#065f46;">AI Alignment Analysis</h4>
                {% if milo_alignment.match_score is defined %}
                    <p><strong>Match score:</strong> {{ milo_alignment.match_score }} / 100</p>
                {% endif %}
                {% if milo_alignment.nextgen_align_score is defined %}
                    <p><strong>NextGen align score:</strong> {{ milo_alignment.nextgen_align_score }} / 100</p>
                {% endif %}
                {% if milo_alignment.explanation %}
                    <p><em>{{ milo_alignment.explanation }}</em></p>
                {% endif %}
            </div>
        {% endif %}
    </div>

    {# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  ACTIONS  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• #}
    <div class="section" style="display:flex; justify-content:flex-end; gap:1rem;">
        <a href="{{ url_for('students') }}" class="btn btn-secondary" style="padding:0.6rem 1.2rem;">â† Back to Students</a>
        <button onclick="confirmDeleteThisStudent()" class="btn" style="padding:0.6rem 1.2rem; background:#ef4444; color:white; border:none; border-radius:4px; cursor:pointer;">ğŸ—‘ï¸ Delete Student</button>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="detailDeleteModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:center;">
        <div style="background:white; border-radius:12px; padding:2rem; max-width:440px; width:90%; box-shadow:0 20px 60px rgba(0,0,0,0.3); text-align:center;">
            <h3 style="color:#991b1b; margin-bottom:1rem;">âš ï¸ Delete Student Record</h3>
            <p style="color:#4b5563; margin-bottom:1.5rem;">Permanently delete <strong>{{ summary.name }}</strong> and all agent evaluations? This cannot be undone.</p>
            <div style="display:flex; gap:1rem; justify-content:center;">
                <button onclick="document.getElementById('detailDeleteModal').style.display='none'" class="btn btn-secondary">Cancel</button>
                <button onclick="deleteThisStudent()" id="detailDeleteBtn" class="btn" style="background:#ef4444; color:white; border:none; border-radius:4px; cursor:pointer;">ğŸ—‘ï¸ Delete Permanently</button>
            </div>
        </div>
    </div>

    <script>
    function confirmDeleteThisStudent() {
        document.getElementById('detailDeleteModal').style.display = 'flex';
    }
    function deleteThisStudent() {
        var btn = document.getElementById('detailDeleteBtn');
        btn.textContent = 'Deleting...';
        btn.disabled = true;
        fetch('/api/student/{{ summary.application_id }}/delete', { method: 'DELETE' })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.status === 'success') {
                    window.location.href = '{{ url_for("students") }}';
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                    btn.textContent = 'ğŸ—‘ï¸ Delete Permanently';
                    btn.disabled = false;
                }
            })
            .catch(function(err) {
                alert('Network error: ' + err);
                btn.textContent = 'ğŸ—‘ï¸ Delete Permanently';
                btn.disabled = false;
            });
    }
    document.addEventListener('keydown', function(e) { if (e.key === 'Escape') document.getElementById('detailDeleteModal').style.display='none'; });
    </script>

    {# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  APPLICATION CONTENT  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• #}
    <div class="section">
        <div class="section-title">Application Content</div>
        <div style="background: #f1f5f9; padding: 1.2rem; border-radius: 8px;">
            <p style="white-space: pre-wrap; color: #334155;">{{ summary.text_preview }}</p>
            {% if summary is defined and 'word_count' in summary and summary['word_count'] > 250 %}
                <p style="color: #64748b; font-size: 0.95rem; margin-top: 1rem; font-style: italic;">... [{{ summary['word_count'] - 250 }} more words]</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
{% extends "base.html" %}

{% block title %}Upload Application{% endblock %}

{% block content %}
<div class="card">
    <h2>üì§ Upload Application</h2>
    <p style="color: #6b7280; margin: 1rem 0;">
        Upload a student application file. Smee will extract the student info automatically and organize it.
    </p>
</div>

<div class="card">
    <form method="POST" enctype="multipart/form-data" style="margin-top: 1.5rem;">
        <!-- File Upload -->
        <div id="applicationTypeSection" style="margin-bottom: 2rem;">
            <label style="display: block; font-weight: 600; margin-bottom: 0.75rem; color: #1f2937;">
                üìÑ Application Files *
            </label>
            <div style="border: 2px dashed #667eea; border-radius: 8px; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.2s;" 
                 onmouseover="this.style.background='#f0f9ff'; this.style.borderColor='#3b82f6'"
                 onmouseout="this.style.background=''; this.style.borderColor='#667eea'"
                 onclick="document.getElementById('fileInput').click()">
                  <input type="file" id="fileInput" name="file" required multiple accept=".pdf,.docx,.doc,.txt,.text"
                       style="display: none;" onchange="updateFileName(this)">
                <svg style="width: 48px; height: 48px; margin-bottom: 1rem;" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <p style="font-weight: 600; color: #667eea; margin-bottom: 0.5rem;">
                    Drag & drop or click to select files
                </p>
                <p style="color: #6b7280; font-size: 0.9rem;">
                    Supported: PDF, DOCX, DOC, TXT (Max 16MB each)
                </p>
                <p id="fileName" style="color: #10b981; font-weight: 600; margin-top: 1rem; display: none;"></p>
            </div>
        </div>

        <!-- Application Type Selection -->
        <div style="margin-bottom: 2rem;">
            <label style="display: block; font-weight: 600; margin-bottom: 1rem; color: #1f2937;">
                üìã Application Type
            </label>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                <!-- 2026 Applicant (Default) -->
                <label style="display: flex; flex-direction: column; padding: 1.5rem; background: #f0fdf4; border: 2px solid #10b981; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                    <input type="radio" name="app_type" value="2026" id="type2026" checked onchange="updateApplicationType()"
                           style="margin-bottom: 0.5rem;">
                    <span style="font-weight: 600; color: #065f46; margin-bottom: 0.5rem;">üÜï 2026 Applicant</span>
                    <span style="color: #047857; font-size: 0.85rem;">Real application for current admission cycle</span>
                </label>
                
                <!-- Test Upload -->
                <label style="display: flex; flex-direction: column; padding: 1.5rem; background: #f0f9ff; border: 2px solid #3b82f6; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                    <input type="radio" name="app_type" value="test" id="typeTest" onchange="updateApplicationType()"
                           style="margin-bottom: 0.5rem;">
                    <span style="font-weight: 600; color: #1e40af; margin-bottom: 0.5rem;">üß™ Test Upload</span>
                    <span style="color: #1e40af; font-size: 0.85rem;">Test the agents with sample files</span>
                </label>
                
                <!-- Training Data -->
                <label style="display: flex; flex-direction: column; padding: 1.5rem; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                    <input type="radio" name="app_type" value="training" id="typeTraining" onchange="updateApplicationType()"
                           style="margin-bottom: 0.5rem;">
                    <span style="font-weight: 600; color: #92400e; margin-bottom: 0.5rem;">üìö Training Data</span>
                    <span style="color: #92400e; font-size: 0.85rem;">Historical data from previous years</span>
                </label>
            </div>
        </div>

        <!-- Selection Status (shown only for training data) -->
        <div id="selectionStatus" style="display: none; margin-bottom: 2rem; padding: 1.5rem; background: #fef3c7; border-radius: 8px; border: 2px solid #fcd34d;">
            <p style="margin: 0 0 0.75rem 0; color: #78350f; font-weight: 600;">
                ‚úÖ Was this student accepted?
            </p>
            <div style="display: flex; gap: 1.5rem; align-items: center;">
                <label style="display: flex; align-items: center; cursor: pointer; font-weight: 600;">
                    <input type="radio" name="was_selected" value="yes" style="margin-right: 0.5rem;">
                    <span style="color: #78350f;">Yes</span>
                </label>
                <label style="display: flex; align-items: center; cursor: pointer; font-weight: 600;">
                    <input type="radio" name="was_selected" value="no" style="margin-right: 0.5rem;">
                    <span style="color: #78350f;">No</span>
                </label>
            </div>
            <p style="color: #92400e; margin-top: 0.5rem; font-size: 0.9rem;">
                This helps the system learn what strong applicants look like.
            </p>
        </div>

        <!-- Type Information Display -->
        <div id="typeInfoDisplay" style="padding: 1.5rem; background: #f0fdf4; border-left: 4px solid #10b981; border-radius: 8px; margin-bottom: 2rem;">
            <h3 style="color: #065f46; margin-bottom: 0.5rem;">üÜï 2026 Applicant</h3>
            <p style="color: #047857; margin: 0;">This will be processed immediately by Smee and all agents for evaluation.</p>
        </div>

        <!-- Submit Button -->
        <button type="submit" class="btn btn-success" style="padding: 0.75rem 2rem; font-size: 1rem;">
            üì• Upload File
        </button>
    </form>
</div>

<!-- Info Card -->
<div class="card" style="background: #f0f9ff; border-left: 4px solid #3b82f6;">
    <h3 style="color: #1e40af; margin-bottom: 1rem;">‚ÑπÔ∏è What Happens Next</h3>
    <div style="color: #1e40af; line-height: 1.8;">
        <ol style="margin-left: 1.5rem;">
            <li style="margin-bottom: 0.75rem;">
                <strong>File Upload:</strong> Your documents are uploaded to Azure Storage
            </li>
            <li style="margin-bottom: 0.75rem;">
                <strong>Student ID Created:</strong> Smee generates a unique ID for this student
            </li>
            <li style="margin-bottom: 0.75rem;">
                <strong>Student Info Extracted:</strong> Name, email, and application text are automatically extracted
            </li>
            <li style="margin-bottom: 0.75rem;">
                <strong>Organized in Storage:</strong> Files organized by type (2026/training/test) and student ID
            </li>
            <li>
                <strong>Processing Behavior:</strong> 2026 and test uploads trigger agent processing; training uploads refresh the Milo dataset only
            </li>
        </ol>
        <p style="margin-top: 1rem;">
            <strong>Evaluation Standard:</strong> Training applicants are often top performers (though not always), and every file
            runs through the same rigorous, multi-step evaluation so the final recommendation reflects a full perspective.
        </p>
        <p style="margin-top: 1rem;">
            <strong>Status Tip:</strong> Track progress on the Applicants or Training pages. "Needs Docs" means transcripts or recommendations are still missing.
        </p>
    </div>
</div>

<script>
function updateFileName(input) {
    const fileName = document.getElementById('fileName');
    if (input.files && input.files.length > 0) {
        if (input.files.length === 1) {
            fileName.textContent = '‚úì ' + input.files[0].name;
        } else {
            const names = Array.from(input.files).slice(0, 3).map(file => file.name).join(', ');
            const moreCount = input.files.length > 3 ? ` (+${input.files.length - 3} more)` : '';
            fileName.textContent = `‚úì ${input.files.length} files: ${names}${moreCount}`;
        }
        fileName.style.display = 'block';
    }
}

function updateApplicationType() {
    const type2026 = document.getElementById('type2026').checked;
    const typeTest = document.getElementById('typeTest').checked;
    const typeTraining = document.getElementById('typeTraining').checked;
    const typeInfoDisplay = document.getElementById('typeInfoDisplay');
    const selectionStatus = document.getElementById('selectionStatus');
    
    if (type2026) {
        typeInfoDisplay.innerHTML = `
            <h3 style="color: #065f46; margin-bottom: 0.5rem;">üÜï 2026 Applicant</h3>
            <p style="color: #047857; margin: 0;">This will be processed immediately by Smee and all agents for evaluation.</p>
        `;
        typeInfoDisplay.style.background = '#f0fdf4';
        typeInfoDisplay.style.borderLeft = '4px solid #10b981';
        selectionStatus.style.display = 'none';
    } else if (typeTest) {
        typeInfoDisplay.innerHTML = `
            <h3 style="color: #1e40af; margin-bottom: 0.5rem;">üß™ Test Upload</h3>
            <p style="color: #1e40af; margin: 0;">This will be processed as test data to evaluate agent performance. You can navigate away and return to see results.</p>
        `;
        typeInfoDisplay.style.background = '#f0f9ff';
        typeInfoDisplay.style.borderLeft = '4px solid #3b82f6';
        selectionStatus.style.display = 'none';
    } else if (typeTraining) {
        typeInfoDisplay.innerHTML = `
            <h3 style="color: #b45309; margin-bottom: 0.5rem;">üìö Training Data</h3>
            <p style="color: #92400e; margin: 0;">This will be saved as historical training data to learn from.</p>
        `;
        typeInfoDisplay.style.background = '#fef3c7';
        typeInfoDisplay.style.borderLeft = '4px solid #f59e0b';
        selectionStatus.style.display = 'block';
    }
}

function applyTrainingPreset() {
    const params = new URLSearchParams(window.location.search);
    const presetType = params.get('app_type');
    if (presetType !== 'training') {
        return;
    }

    const typeTraining = document.getElementById('typeTraining');
    const type2026 = document.getElementById('type2026');
    const typeTest = document.getElementById('typeTest');
    const typeSection = document.getElementById('applicationTypeSection');

    if (typeTraining && type2026 && typeTest) {
        typeTraining.checked = true;
        type2026.checked = false;
        typeTest.checked = false;
    }

    if (typeSection) {
        typeSection.style.display = 'none';
    }

    updateApplicationType();
}

// Drag and drop
const dropZone = document.querySelector('[style*="border: 2px dashed"]');
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

['dragenter', 'dragover'].forEach(eventName => {
    dropZone.addEventListener(eventName, highlight, false);
});

['dragleave', 'drop'].forEach(eventName => {
    dropZone.addEventListener(eventName, unhighlight, false);
});

function highlight(e) {
    dropZone.style.background = '#f0f9ff';
    dropZone.style.borderColor = '#3b82f6';
}

function unhighlight(e) {
    dropZone.style.background = '';
    dropZone.style.borderColor = '#667eea';
}

dropZone.addEventListener('drop', handleDrop, false);

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    document.getElementById('fileInput').files = files;
    updateFileName(document.getElementById('fileInput'));
}

applyTrainingPreset();
</script>

{% endblock %}
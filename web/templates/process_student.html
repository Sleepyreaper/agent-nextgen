{% extends "base.html" %}

{% block title %}Processing {{ application.applicantname }} - Student Evaluation{% endblock %}

{% block extra_css %}
<style>
    .processing-container {
        max-width: 800px;
        margin: 0 auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="processing-container">
    <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
        <h1>ðŸ¤– Processing Student Application</h1>
        <p style="font-size: 1.2rem; margin-top: 0.5rem;">{{ application.applicantname }}</p>
    </div>

    <div class="card">
        <!-- Agent Progress Panel -->
        <div id="process-progress-panel"></div>
        {% include '_agent_progress.html' %}

        <div id="error-container" style="display: none; margin-top: 2rem; padding: 1rem; background: #fef2f2; border-left: 4px solid #ef4444; border-radius: 5px;">
            <strong style="color: #991b1b;">Error:</strong>
            <p id="error-message" style="color: #991b1b; margin-top: 0.5rem;"></p>
        </div>

        <div id="complete-container" style="display: none; margin-top: 2rem; text-align: center;">
            <div style="font-size: 4rem; margin-bottom: 1rem;">âœ…</div>
            <h2 style="color: #10b981;">Processing Complete!</h2>
            <p style="color: #6b7280; margin: 1rem 0;">All agents have finished analyzing {{ application.applicantname }}'s application.</p>
            <a href="{{ url_for('student_detail', application_id=application_id) }}" class="btn btn-success">View Student Summary â†’</a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const APPLICATION_ID = '{{ application_id }}';

function processStudent() {
    AgentProgress.init('process-progress-panel');

    const eventSource = new EventSource(`/api/process/stream/${APPLICATION_ID}`);

    eventSource.onmessage = (event) => {
        if (!event.data) return;
        const update = JSON.parse(event.data);

        if (update.type === 'agent_progress') {
            const agentId = update.agent_id || update.agent || 'unknown';
            const status = update.status || 'processing';
            const message = update.message || '';
            AgentProgress.update(agentId, status, message);
        } else if (update.type === 'evaluation_paused') {
            // Nothing extra needed â€” individual agents already show blocked
        } else if (update.type === 'evaluation_complete' || update.type === 'orchestration_complete') {
            AgentProgress.markAllComplete();
            if (update.result && update.result.status === 'paused') {
                // Paused â€” don't show complete screen
            } else {
                document.getElementById('complete-container').style.display = 'block';
            }
            eventSource.close();
        } else if (update.type === 'orchestration_error' || update.type === 'error') {
            document.getElementById('error-message').textContent = update.error || 'Processing failed';
            document.getElementById('error-container').style.display = 'block';
            eventSource.close();
        }
    };

    eventSource.onerror = () => {
        // SSE will auto-reconnect
    };
}

window.addEventListener('load', () => {
    processStudent();
});
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Training Data{% endblock %}

{% block content %}
<style>
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}
</style>
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 2rem; gap: 1rem;">
        <div>
            <h2>üìö Training Data</h2>
            <p style="color: #6b7280; margin-top: 0.5rem;">
                Historical applications sorted by last name. Students marked "Selected" became our successful interns.
            </p>
            <p style="color: #6b7280; margin-top: 0.5rem;">
                Status badges show selection outcomes and whether training data is fully captured.
            </p>
            <div style="margin-top: 0.75rem;">
                <a href="{{ url_for('import_scores_page') }}" style="display: inline-flex; align-items: center; gap: 0.4rem; background: #f59e0b; color: #78350f; padding: 0.4rem 1rem; border-radius: 6px; text-decoration: none; font-weight: 600; font-size: 0.85rem;">
                    üìä Import Historical Scores
                </a>
            </div>
        </div>
        <div style="width:100%; margin-top:1rem;">
            <!-- inline upload form for training files -->
            <div class="card" style="padding:1rem; background:#f9fafb;">
                <h3 style="margin-top:0;">‚ûï Upload Training Files</h3>
                <form method="POST" action="{{ url_for('upload') }}" enctype="multipart/form-data" id="trainingUploadForm">
                    <input type="hidden" name="app_type" value="training" />
                    <div style="border:2px dashed #f59e0b; border-radius:8px; padding:1.5rem; text-align:center; cursor:pointer;" 
                         onclick="document.getElementById('trainingFileInput').click()">
                        <input type="file" id="trainingFileInput" name="file" required accept=".pdf,.docx,.doc,.txt,.text,.mp4" multiple style="display:none;" onchange="updateTrainingFileName(this)">
                        <p style="color:#92400e; font-weight:600;">Drag & drop or click to select training files</p>
                        <p style="color:#b45309; font-size:0.8rem; margin-top:0.25rem;">You can select multiple files at once</p>
                        <p id="trainingFileName" style="color:#92400e; font-weight:600; display:none;"></p>
                        <p id="trainingVideoSizeHint" style="color:#667eea; font-size:0.85rem; margin-top:0.5rem; display:none;"></p>
                    </div>
                    <!-- Video upload progress bar -->
                    <div id="trainingVideoProgress" style="display:none; margin-top:1rem;">
                        <p id="trainingVideoProgressText" style="color:#1e40af; font-weight:600; margin-bottom:0.5rem;">Uploading video‚Ä¶</p>
                        <div style="background:#e5e7eb; border-radius:8px; overflow:hidden; height:24px;">
                            <div id="trainingVideoProgressBar" style="background:linear-gradient(90deg,#667eea,#764ba2); height:100%; width:0%; transition:width 0.3s; color:#fff; font-size:0.8rem; line-height:24px; text-align:center; border-radius:8px;">0%</div>
                        </div>
                    </div>
                    <input type="hidden" id="trainingVideoBlobInfo" name="video_blob_info" value="">
                    </div>
                    <div id="trainingSelectionStatus" style="margin-top:1rem; display:flex; gap:1.5rem; align-items:center;">
                        <label style="display:flex; align-items:center; cursor:pointer; font-weight:600;">
                            <input type="radio" name="was_selected" value="yes" style="margin-right:0.5rem;">
                            <span style="color:#78350f;">Yes</span>
                        </label>
                        <label style="display:flex; align-items:center; cursor:pointer; font-weight:600;">
                            <input type="radio" name="was_selected" value="no" style="margin-right:0.5rem;">
                            <span style="color:#78350f;">No</span>
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary" style="margin-top:1rem;">Upload</button>
                </form>
            </div>
        </div>
        <div style="display: flex; gap: 0.75rem; align-items:center;">
            <button type="button" class="btn btn-secondary" onclick="clearTrainingData()">
                üßπ Clear Training Data
            </button>
            <button type="button" class="btn" style="background:#ef4444; color:white;" onclick="findDuplicates()">
                üîç Find Duplicates
            </button>
            <button type="button" class="btn" style="background:#f59e0b; color:#78350f;" onclick="openXlsxResolver()">
                üîó Resolve XLSX Matches
            </button>
            <button type="button" class="btn btn-info" onclick="fetchMiloInsights()">
                üìä Milo Insights
            </button>
            <a id="trainingUploadLink" href="{{ url_for('upload', app_type='training') }}" class="btn btn-primary">
                ‚ûï Add Training Example
            </a>
        </div>
    </div>

    <!-- Statistics -->
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 2rem;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 8px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold;">{{ total_count }}</div>
            <div style="opacity: 0.9; margin-top: 0.5rem;">Total Examples</div>
        </div>
        <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 1.5rem; border-radius: 8px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold;">{{ selected_count }}</div>
            <div style="opacity: 0.9; margin-top: 0.5rem;">‚úì Selected</div>
        </div>
        <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 1.5rem; border-radius: 8px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold;">{{ not_selected_count }}</div>
            <div style="opacity: 0.9; margin-top: 0.5rem;">‚úó Not Selected</div>
        </div>
        <div style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; padding: 1.5rem; border-radius: 8px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold;">{{ matched_count }}</div>
            <div style="opacity: 0.9; margin-top: 0.5rem;">üìä XLSX Matched</div>
        </div>
    </div>

    <!-- Search and Filter -->
    <form method="GET" style="margin-bottom: 2rem;">
        <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 1rem;">
            <input type="text" name="search" placeholder="üîç Search by name or email..." 
                   value="{{ search_query or '' }}"
                   style="padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 5px; font-size: 1rem;">
            
            <select name="filter" style="padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 5px; font-size: 1rem;">
                <option value="">All Examples</option>
                <option value="selected" {% if filter_selected == 'selected' %}selected{% endif %}>‚úì Selected Only</option>
                <option value="not_selected" {% if filter_selected == 'not_selected' %}selected{% endif %}>‚úó Not Selected</option>
            </select>
            
            <button type="submit" class="btn btn-primary">Search</button>
        </div>
    </form>

    {% set has_processing = training_data|selectattr('status', 'equalto', 'Processing')|list|length > 0 %}
    {% if has_processing %}
    <div style="margin-bottom: 1.5rem; padding: 0.85rem 1rem; border-radius: 8px; background: #eff6ff; color: #1e40af; display: flex; align-items: center; gap: 0.75rem;">
        <span style="display: inline-block; width: 12px; height: 12px; border-radius: 999px; background: #3b82f6; animation: pulse 1s infinite;"></span>
        <div>
            <strong>Processing training uploads...</strong> This page will refresh automatically.
        </div>
    </div>
    {% endif %}

    <!-- Training Data List Component -->
    {% set students = training_data %}
    {% include '_student_list.html' %}
</div>

<!-- Duplicates Modal -->
<div id="dupModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); z-index:9999; justify-content:center; align-items:center;">
    <div style="background:white; border-radius:12px; padding:2rem; max-width:720px; width:95%; max-height:80vh; overflow-y:auto; box-shadow:0 20px 60px rgba(0,0,0,0.3);">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
            <h3 style="margin:0; color:#991b1b;">üîç Duplicate Training Records</h3>
            <button onclick="closeDupModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">‚úï</button>
        </div>
        <div id="dupContent">
            <p style="text-align:center; color:#6b7280;">Loading...</p>
        </div>
        <div id="dupActions" style="display:none; margin-top:1.5rem; padding-top:1rem; border-top:1px solid #e5e7eb; text-align:right;">
            <span id="dupSelectedCount" style="color:#6b7280; margin-right:1rem;">0 selected</span>
            <button onclick="closeDupModal()" class="btn btn-secondary" style="margin-right:0.5rem;">Cancel</button>
            <button onclick="bulkDeleteSelected()" id="dupDeleteBtn" class="btn" style="background:#ef4444; color:white;" disabled>
                üóëÔ∏è Delete Selected
            </button>
        </div>
    </div>
</div>

<!-- Info Card -->
<div class="card" style="background: #f0f9ff; border-left: 4px solid #3b82f6; margin-top: 2rem;">

<!-- XLSX Resolver Modal -->
<div id="xlsxModal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); z-index:9999; justify-content:center; align-items:center;">
    <div style="background:white; border-radius:12px; padding:2rem; max-width:900px; width:95%; max-height:85vh; overflow-y:auto; box-shadow:0 20px 60px rgba(0,0,0,0.3);">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
            <h3 style="margin:0; color:#78350f;">üîó Resolve XLSX Matches</h3>
            <button onclick="closeXlsxModal()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">‚úï</button>
        </div>
        <p style="color:#6b7280; margin-bottom:1rem;">
            These training students have no linked historical XLSX score. Search and link them manually.
        </p>
        <div id="xlsxContent">
            <p style="text-align:center; color:#6b7280;">Loading unmatched students...</p>
        </div>
    </div>
</div>
    <h3 style="color: #1e40af; margin-bottom: 1rem;">üí° About Training Data</h3>
    <div style="color: #1e3a8a; line-height: 1.8;">
        <p style="margin-bottom: 1rem;">
            Training data helps the system understand what makes excellent applicants by learning from historical examples.
            The overall score shown is the AI's evaluation of each historical student.
        </p>
        <p style="margin-bottom: 1rem;">
            These applicants are typically top of their class (though not always). Every training example runs through
            the full, rigorous evaluation pipeline so the final recommendation reflects a complete perspective.
        </p>
        <ul style="margin-left: 1.5rem;">
            <li>üßô <strong>Comprehensive evaluation</strong> compares new applicants against historical excellence</li>
            <li>üåä <strong>School context</strong> learns patterns from schools that produced successful students</li>
            <li>üíá <strong>Transcript analysis</strong> calibrates grade expectations based on past selections</li>
            <li>üë∏ <strong>Application review</strong> identifies essay qualities that correlate with success</li>
            <li>üó°Ô∏è <strong>Recommendation analysis</strong> weights recommendation attributes from past winners</li>
        </ul>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function clearTrainingData() {
    if (!confirm('Clear ALL training data (excluding test uploads)? This cannot be undone.')) {
        return;
    }

    try {
        const response = await fetch('/api/training-data/clear', { method: 'POST' });
        const data = await response.json();

        if (!response.ok || data.status !== 'success') {
            alert(`Error: ${data.error || 'Unable to clear training data'}`);
            return;
        }

        alert(`${data.message}`);
        location.reload();
    } catch (error) {
        alert(`Error: ${error.message}`);
    }
}

// ---- Duplicates Feature ----
function closeDupModal() {
    document.getElementById('dupModal').style.display = 'none';
}

async function findDuplicates() {
    const modal = document.getElementById('dupModal');
    const content = document.getElementById('dupContent');
    const actions = document.getElementById('dupActions');
    modal.style.display = 'flex';
    actions.style.display = 'none';
    content.innerHTML = '<p style="text-align:center; color:#6b7280;">üîç Scanning for duplicates...</p>';

    try {
        const r = await fetch('/api/training-data/duplicates');
        const data = await r.json();
        if (data.status !== 'success') {
            content.innerHTML = '<p style="color:#ef4444;">Error: ' + (data.error || 'Unknown') + '</p>';
            return;
        }
        if (!data.groups || data.groups.length === 0) {
            content.innerHTML = '<div style="text-align:center; padding:2rem;"><div style="font-size:3rem;">‚úÖ</div><h3 style="color:#059669; margin:0.5rem 0;">No Duplicates Found</h3><p style="color:#6b7280;">All training records are unique.</p></div>';
            return;
        }

        // Build grouped UI
        let html = '<p style="margin-bottom:1rem; color:#92400e; font-weight:600;">Found <strong>' + data.total_duplicates + '</strong> duplicate record(s) across <strong>' + data.total_groups + '</strong> student(s). Check the duplicates you want to remove ‚Äî the oldest record in each group is unmarked by default.</p>';

        data.groups.forEach((group, gi) => {
            html += '<div style="margin-bottom:1rem; border:1px solid #e5e7eb; border-radius:8px; overflow:hidden;">';
            html += '<div style="background:#fef3c7; padding:0.75rem 1rem; font-weight:600; color:#92400e;">';
            html += 'üë§ ' + (group.first_name || '') + ' ' + (group.last_name || '') + ' ‚Äî ' + group.count + ' records';
            html += '</div>';
            html += '<table style="width:100%; border-collapse:collapse; font-size:0.9rem;">';
            html += '<tr style="background:#f9fafb;"><th style="padding:0.5rem; text-align:left; width:40px;">Del</th><th style="padding:0.5rem; text-align:left;">ID</th><th style="padding:0.5rem; text-align:left;">Name</th><th style="padding:0.5rem; text-align:left;">School</th><th style="padding:0.5rem; text-align:left;">Status</th><th style="padding:0.5rem; text-align:left;">Uploaded</th></tr>';

            group.records.forEach((rec, ri) => {
                const isOldest = (ri === 0);  // keep oldest by default
                const uploaded = rec.uploaded_date ? new Date(rec.uploaded_date).toLocaleDateString() : 'N/A';
                const rowBg = isOldest ? '#f0fdf4' : '#fff';
                html += '<tr style="background:' + rowBg + '; border-top:1px solid #f3f4f6;">';
                html += '<td style="padding:0.5rem; text-align:center;"><input type="checkbox" class="dup-check" value="' + rec.application_id + '" ' + (isOldest ? '' : 'checked') + ' onchange="updateDupCount()"></td>';
                html += '<td style="padding:0.5rem;">' + rec.application_id + '</td>';
                html += '<td style="padding:0.5rem;">' + (rec.first_name || '') + ' ' + (rec.last_name || '') + (isOldest ? ' <span style="background:#dcfce7;color:#166534;padding:0.1rem 0.4rem;border-radius:4px;font-size:0.75rem;">keep</span>' : '') + '</td>';
                html += '<td style="padding:0.5rem;">' + (rec.high_school || 'N/A') + '</td>';
                html += '<td style="padding:0.5rem;">' + (rec.status || '') + '</td>';
                html += '<td style="padding:0.5rem;">' + uploaded + '</td>';
                html += '</tr>';
            });
            html += '</table></div>';
        });

        content.innerHTML = html;
        actions.style.display = 'block';
        updateDupCount();
    } catch (err) {
        content.innerHTML = '<p style="color:#ef4444;">Network error: ' + err.message + '</p>';
    }
}

// Listen for Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeDupModal();
});
document.getElementById('dupModal').addEventListener('click', function(e) {
    if (e.target === this) closeDupModal();
});

function updateDupCount() {
    const checked = document.querySelectorAll('.dup-check:checked');
    document.getElementById('dupSelectedCount').textContent = checked.length + ' selected';
    document.getElementById('dupDeleteBtn').disabled = checked.length === 0;
}

async function bulkDeleteSelected() {
    const checked = document.querySelectorAll('.dup-check:checked');
    const ids = Array.from(checked).map(cb => parseInt(cb.value));
    if (ids.length === 0) return;

    if (!confirm('Permanently delete ' + ids.length + ' duplicate training record(s)? This cannot be undone.')) return;

    const btn = document.getElementById('dupDeleteBtn');
    btn.textContent = 'Deleting...';
    btn.disabled = true;

    try {
        const r = await fetch('/api/training-data/bulk-delete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({application_ids: ids})
        });
        const data = await r.json();
        if (data.status === 'success') {
            alert('Deleted ' + data.deleted + ' duplicate record(s).' + (data.errors.length ? '\nErrors: ' + data.errors.join(', ') : ''));
            closeDupModal();
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown'));
            btn.textContent = 'üóëÔ∏è Delete Selected';
            btn.disabled = false;
        }
    } catch (err) {
        alert('Network error: ' + err.message);
        btn.textContent = 'üóëÔ∏è Delete Selected';
        btn.disabled = false;
    }
}

function updateTrainingFileName(input) {
    const fileName = document.getElementById('trainingFileName');
    if (input.files && input.files.length > 0) {
        if (input.files.length === 1) {
            fileName.textContent = '‚úì ' + input.files[0].name;
        } else {
            fileName.textContent = '‚úì ' + input.files.length + ' files selected';
        }
        fileName.style.display = 'block';
    }
}


// ensure training link works even if CSS overlay prevents default
const trainingLink = document.getElementById('trainingUploadLink');
if (trainingLink) {
    trainingLink.addEventListener('click', function(e) {
        e.preventDefault();
        window.location.href = this.href;
    });
}

async function fetchMiloInsights() {
    try {
        const r = await fetch('/api/milo/insights');
        const data = await r.json();
        if (r.ok && data.status === 'success') {
            alert('Milo insights:\n' + JSON.stringify(data, null, 2));
        } else {
            alert('Milo error: ' + (data.error || JSON.stringify(data)));
        }
    } catch (err) {
        alert('Fetch error: ' + err.message);
    }
}

const hasProcessing = {{ 'true' if has_processing else 'false' }};
if (hasProcessing) {
    setInterval(() => {
        window.location.reload();
    }, 12000);
}

// ---- XLSX Resolver Feature ----
function closeXlsxModal() {
    document.getElementById('xlsxModal').style.display = 'none';
}
document.getElementById('xlsxModal').addEventListener('click', function(e) {
    if (e.target === this) closeXlsxModal();
});
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeXlsxModal();
});

async function openXlsxResolver() {
    const modal = document.getElementById('xlsxModal');
    const content = document.getElementById('xlsxContent');
    modal.style.display = 'flex';
    content.innerHTML = '<p style="text-align:center; color:#6b7280;">üîç Loading unmatched students...</p>';

    try {
        const r = await fetch('/api/training/unmatched');
        const data = await r.json();
        if (data.status !== 'success') {
            content.innerHTML = '<p style="color:#ef4444;">Error: ' + (data.error || 'Unknown') + '</p>';
            return;
        }
        if (!data.students || data.students.length === 0) {
            content.innerHTML = '<div style="text-align:center; padding:2rem;"><div style="font-size:3rem;">‚úÖ</div><h3 style="color:#059669; margin:0.5rem 0;">All Students Matched!</h3><p style="color:#6b7280;">Every training student has a linked XLSX score record.</p></div>';
            return;
        }

        let html = '<p style="margin-bottom:1rem; color:#92400e; font-weight:600;">Found <strong>' + data.students.length + '</strong> unmatched student(s). Click "Search" to find matching XLSX records.</p>';

        data.students.forEach(function(student) {
            const displayName = (student.first_name && student.last_name)
                ? student.first_name + ' ' + student.last_name
                : student.applicant_name || 'Unknown';
            html += '<div id="resolver-' + student.application_id + '" style="margin-bottom:1.25rem; border:1px solid #e5e7eb; border-radius:8px; overflow:hidden;">';
            html += '<div style="background:#fef3c7; padding:0.75rem 1rem; display:flex; justify-content:space-between; align-items:center;">';
            html += '<div><strong style="color:#92400e;">üë§ ' + displayName + '</strong>';
            if (student.email) html += ' <span style="color:#6b7280; font-size:0.85rem;">(' + student.email + ')</span>';
            html += '</div>';
            html += '<div style="display:flex; gap:0.5rem; align-items:center;">';
            html += '<input type="text" id="search-' + student.application_id + '" placeholder="Search XLSX by name..." value="' + displayName + '" style="padding:0.4rem 0.6rem; border:1px solid #d1d5db; border-radius:4px; font-size:0.85rem; width:200px;">';
            html += '<button onclick="searchXlsxFor(' + student.application_id + ')" class="btn btn-primary" style="padding:0.4rem 0.8rem; font-size:0.85rem;">üîç Search</button>';
            html += '</div></div>';
            html += '<div id="results-' + student.application_id + '" style="padding:0.5rem 1rem; color:#6b7280; font-size:0.9rem;">Click Search to find matching XLSX records.</div>';
            html += '</div>';
        });

        content.innerHTML = html;
    } catch (err) {
        content.innerHTML = '<p style="color:#ef4444;">Network error: ' + err.message + '</p>';
    }
}

async function searchXlsxFor(appId) {
    const searchInput = document.getElementById('search-' + appId);
    const resultsDiv = document.getElementById('results-' + appId);
    const query = searchInput.value.trim();
    resultsDiv.innerHTML = '<p style="color:#6b7280;">Searching...</p>';

    try {
        const r = await fetch('/api/historical-scores/unlinked?search=' + encodeURIComponent(query));
        const data = await r.json();
        if (data.status !== 'success') {
            resultsDiv.innerHTML = '<p style="color:#ef4444;">Error: ' + (data.error || 'Unknown') + '</p>';
            return;
        }
        if (!data.scores || data.scores.length === 0) {
            resultsDiv.innerHTML = '<p style="color:#9ca3af;">No unlinked XLSX records found for "' + query + '". Try a different search.</p>';
            return;
        }

        let html = '<table style="width:100%; border-collapse:collapse; font-size:0.85rem; margin-top:0.25rem;">';
        html += '<tr style="background:#f9fafb;"><th style="padding:0.4rem; text-align:left;">Name</th><th style="padding:0.4rem; text-align:left;">Status</th><th style="padding:0.4rem; text-align:center;">Total Rating</th><th style="padding:0.4rem; text-align:center;">Acad</th><th style="padding:0.4rem; text-align:center;">STEM</th><th style="padding:0.4rem; text-align:center;">Essay</th><th style="padding:0.4rem; text-align:center;">Rec</th><th style="padding:0.4rem; text-align:center;">Action</th></tr>';

        data.scores.forEach(function(score) {
            const selected = score.was_selected === true ? '‚úì Selected' : (score.was_selected === false ? '‚úó Not Selected' : '‚Äî');
            const selColor = score.was_selected === true ? '#059669' : (score.was_selected === false ? '#dc2626' : '#6b7280');
            html += '<tr style="border-top:1px solid #f3f4f6;">';
            html += '<td style="padding:0.4rem;">' + (score.applicant_name || '‚Äî') + '</td>';
            html += '<td style="padding:0.4rem;"><span style="color:' + selColor + '; font-weight:600; font-size:0.8rem;">' + selected + '</span></td>';
            html += '<td style="padding:0.4rem; text-align:center; font-weight:600;">' + (score.total_rating != null ? score.total_rating : '‚Äî') + '</td>';
            html += '<td style="padding:0.4rem; text-align:center;">' + (score.academic_record != null ? score.academic_record : '‚Äî') + '</td>';
            html += '<td style="padding:0.4rem; text-align:center;">' + (score.stem_interest != null ? score.stem_interest : '‚Äî') + '</td>';
            html += '<td style="padding:0.4rem; text-align:center;">' + (score.essay_video != null ? score.essay_video : '‚Äî') + '</td>';
            html += '<td style="padding:0.4rem; text-align:center;">' + (score.recommendation != null ? score.recommendation : '‚Äî') + '</td>';
            html += '<td style="padding:0.4rem; text-align:center;"><button onclick="linkScore(' + appId + ', ' + score.score_id + ', this)" class="btn btn-success" style="padding:0.3rem 0.6rem; font-size:0.8rem;">üîó Link</button></td>';
            html += '</tr>';
        });
        html += '</table>';
        resultsDiv.innerHTML = html;
    } catch (err) {
        resultsDiv.innerHTML = '<p style="color:#ef4444;">Network error: ' + err.message + '</p>';
    }
}

async function linkScore(appId, scoreId, btn) {
    btn.textContent = 'Linking...';
    btn.disabled = true;

    try {
        const r = await fetch('/api/training/link-score', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({application_id: appId, score_id: scoreId})
        });
        const data = await r.json();
        if (data.status === 'success') {
            const card = document.getElementById('resolver-' + appId);
            if (card) {
                card.style.background = '#f0fdf4';
                card.innerHTML = '<div style="padding:1rem; color:#059669; font-weight:600;">‚úÖ Linked successfully ‚Äî score ' + scoreId + ' ‚Üí application ' + appId + '</div>';
            }
        } else {
            alert('Error: ' + (data.error || 'Unknown'));
            btn.textContent = 'üîó Link';
            btn.disabled = false;
        }
    } catch (err) {
        alert('Network error: ' + err.message);
        btn.textContent = 'üîó Link';
        btn.disabled = false;
    }
}
</script>
<script src="{{ url_for('static', filename='js/video-upload.js') }}"></script>
<script>
VideoUpload.init({
    fileInputId:   'trainingFileInput',
    formId:        'trainingUploadForm',
    progressId:    'trainingVideoProgress',
    progressBarId: 'trainingVideoProgressBar',
    progressTextId:'trainingVideoProgressText',
    hiddenFieldId: 'trainingVideoBlobInfo',
    appTypeGetter: () => 'training'
});
</script>
{% endblock %}

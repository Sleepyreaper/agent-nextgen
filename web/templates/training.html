{% extends "base.html" %}

{% block title %}Training Data{% endblock %}

{% block content %}
<style>
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}
</style>
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 2rem; gap: 1rem;">
        <div>
            <h2>ğŸ“š Training Data</h2>
            <p style="color: #6b7280; margin-top: 0.5rem;">
                Historical applications sorted by last name. Students marked "Selected" became our successful interns.
            </p>
            <p style="color: #6b7280; margin-top: 0.5rem;">
                Status badges show selection outcomes and whether training data is fully captured.
            </p>
        </div>
        <div style="width:100%; margin-top:1rem;">
            <!-- inline upload form for training files -->
            <div class="card" style="padding:1rem; background:#f9fafb;">
                <h3 style="margin-top:0;">â• Upload Training File</h3>
                <form method="POST" action="{{ url_for('upload') }}" enctype="multipart/form-data" id="trainingUploadForm">
                    <input type="hidden" name="app_type" value="training" />
                    <div style="border:2px dashed #f59e0b; border-radius:8px; padding:1.5rem; text-align:center; cursor:pointer;" 
                         onclick="document.getElementById('trainingFileInput').click()">
                        <input type="file" id="trainingFileInput" name="file" required accept=".pdf,.docx,.doc,.txt,.text" style="display:none;" onchange="updateTrainingFileName(this)">
                        <p style="color:#92400e; font-weight:600;">Drag & drop or click to select training file</p>
                        <p id="trainingFileName" style="color:#92400e; font-weight:600; display:none;"></p>
                    </div>
                    <div id="trainingSelectionStatus" style="margin-top:1rem; display:flex; gap:1.5rem; align-items:center;">
                        <label style="display:flex; align-items:center; cursor:pointer; font-weight:600;">
                            <input type="radio" name="was_selected" value="yes" style="margin-right:0.5rem;">
                            <span style="color:#78350f;">Yes</span>
                        </label>
                        <label style="display:flex; align-items:center; cursor:pointer; font-weight:600;">
                            <input type="radio" name="was_selected" value="no" style="margin-right:0.5rem;">
                            <span style="color:#78350f;">No</span>
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary" style="margin-top:1rem;">Upload</button>
                </form>
            </div>
        </div>
        <div style="display: flex; gap: 0.75rem; align-items:center;">
            <button type="button" class="btn btn-secondary" onclick="clearTrainingData()">
                ğŸ§¹ Clear Training Data
            </button>
            <button type="button" class="btn btn-info" onclick="fetchMiloInsights()">
                ğŸ“Š Milo Insights
            </button>
            <button type="button" class="btn btn-danger" onclick="resetDatabase()">
                âš ï¸ Reset Database
            </button>
            <label style="margin-left:0.5rem; font-size:0.9rem; color:#374151;">
                <input type="checkbox" id="keepProd" checked style="margin-right:0.25rem;">Keep production
            </label>
            <a id="trainingUploadLink" href="{{ url_for('upload', app_type='training') }}" class="btn btn-primary">
                â• Add Training Example
            </a>
        </div>
    </div>

    <!-- Statistics -->
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 8px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold;">{{ total_count }}</div>
            <div style="opacity: 0.9; margin-top: 0.5rem;">Total Examples</div>
        </div>
        <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 1.5rem; border-radius: 8px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold;">{{ selected_count }}</div>
            <div style="opacity: 0.9; margin-top: 0.5rem;">âœ“ Selected</div>
        </div>
        <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 1.5rem; border-radius: 8px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold;">{{ not_selected_count }}</div>
            <div style="opacity: 0.9; margin-top: 0.5rem;">âœ— Not Selected</div>
        </div>
    </div>

    <!-- Search and Filter -->
    <form method="GET" style="margin-bottom: 2rem;">
        <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 1rem;">
            <input type="text" name="search" placeholder="ğŸ” Search by name or email..." 
                   value="{{ search_query or '' }}"
                   style="padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 5px; font-size: 1rem;">
            
            <select name="filter" style="padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 5px; font-size: 1rem;">
                <option value="">All Examples</option>
                <option value="selected" {% if filter_selected == 'selected' %}selected{% endif %}>âœ“ Selected Only</option>
                <option value="not_selected" {% if filter_selected == 'not_selected' %}selected{% endif %}>âœ— Not Selected</option>
            </select>
            
            <button type="submit" class="btn btn-primary">Search</button>
        </div>
    </form>

    {% set has_processing = training_data|selectattr('status', 'equalto', 'Processing')|list|length > 0 %}
    {% if has_processing %}
    <div style="margin-bottom: 1.5rem; padding: 0.85rem 1rem; border-radius: 8px; background: #eff6ff; color: #1e40af; display: flex; align-items: center; gap: 0.75rem;">
        <span style="display: inline-block; width: 12px; height: 12px; border-radius: 999px; background: #3b82f6; animation: pulse 1s infinite;"></span>
        <div>
            <strong>Processing training uploads...</strong> This page will refresh automatically.
        </div>
    </div>
    {% endif %}

    <!-- Training Data List Component -->
    {% set students = training_data %}
    {% include '_student_list.html' %}
</div>

<!-- Info Card -->
<div class="card" style="background: #f0f9ff; border-left: 4px solid #3b82f6; margin-top: 2rem;">
    <h3 style="color: #1e40af; margin-bottom: 1rem;">ğŸ’¡ About Training Data</h3>
    <div style="color: #1e3a8a; line-height: 1.8;">
        <p style="margin-bottom: 1rem;">
            Training data helps the system understand what makes excellent applicants by learning from historical examples.
            The overall score shown is the AI's evaluation of each historical student.
        </p>
        <p style="margin-bottom: 1rem;">
            These applicants are typically top of their class (though not always). Every training example runs through
            the full, rigorous evaluation pipeline so the final recommendation reflects a complete perspective.
        </p>
        <ul style="margin-left: 1.5rem;">
            <li>ğŸ§™ <strong>Comprehensive evaluation</strong> compares new applicants against historical excellence</li>
            <li>ğŸŒŠ <strong>School context</strong> learns patterns from schools that produced successful students</li>
            <li>ğŸ’‡ <strong>Transcript analysis</strong> calibrates grade expectations based on past selections</li>
            <li>ğŸ‘¸ <strong>Application review</strong> identifies essay qualities that correlate with success</li>
            <li>ğŸ—¡ï¸ <strong>Recommendation analysis</strong> weights recommendation attributes from past winners</li>
        </ul>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function clearTrainingData() {
    if (!confirm('Clear ALL training data (excluding test uploads)? This cannot be undone.')) {
        return;
    }

    try {
        const response = await fetch('/api/training-data/clear', { method: 'POST' });
        const data = await response.json();

        if (!response.ok || data.status !== 'success') {
            alert(`Error: ${data.error || 'Unable to clear training data'}`);
            return;
        }

        alert(`${data.message}`);
        location.reload();
    } catch (error) {
        alert(`Error: ${error.message}`);
    }
}

async function resetDatabase() {
    if (!confirm('This will clear all test and training records. Proceed?')) {
        return;
    }
    const keep = document.getElementById('keepProd').checked;
    try {
        const resp = await fetch('/api/admin/reset', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({keep_production: keep})
        });
        const data = await resp.json();
        if (!resp.ok || data.status !== 'success') {
            alert(`Reset failed: ${data.error || 'unknown error'}`);
            return;
        }
        let msg = 'Database reset completed.';
        if (keep) {
            msg = `Removed ${data.training_deleted || 0} training and ${data.test_deleted || 0} test records.`;
        } else {
            msg = `Removed ${data.deleted || 0} total rows from all tables.`;
        }
        alert(msg);
        location.reload();
    } catch (err) {
        alert(`Error: ${err.message}`);
    }
}

function updateTrainingFileName(input) {
    const fileName = document.getElementById('trainingFileName');
    if (input.files && input.files.length > 0) {
        fileName.textContent = 'âœ“ ' + input.files[0].name;
        fileName.style.display = 'block';
    }
}


// ensure training link works even if CSS overlay prevents default
const trainingLink = document.getElementById('trainingUploadLink');
if (trainingLink) {
    trainingLink.addEventListener('click', function(e) {
        e.preventDefault();
        window.location.href = this.href;
    });
}

async function fetchMiloInsights() {
    try {
        const r = await fetch('/api/milo/insights');
        const data = await r.json();
        if (r.ok && data.status === 'success') {
            alert('Milo insights:\n' + JSON.stringify(data, null, 2));
        } else {
            alert('Milo error: ' + (data.error || JSON.stringify(data)));
        }
    } catch (err) {
        alert('Fetch error: ' + err.message);
    }
}

const hasProcessing = {{ 'true' if has_processing else 'false' }};
if (hasProcessing) {
    setInterval(() => {
        window.location.reload();
    }, 12000);
}
</script>
{% endblock %}

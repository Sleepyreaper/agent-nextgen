{% extends "base.html" %}

{% block title %}Real-Time Test System{% endblock %}

{% block extra_css %}
<style>
    .test-view {
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }
    
    .live-stream {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        max-height: 70vh;
        overflow-y: auto;
        padding: 1.5rem;
        background: #f9fafb;
        border-radius: 8px;
        border: 2px solid #e5e7eb;
    }
    
    .student-card {
        padding: 1.5rem;
        background: white;
        border-radius: 8px;
        border-left: 4px solid #3b82f6;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .student-card.complete {
        border-left-color: #10b981;
        background: #f0fdf4;
    }
    
    .student-card.processing {
        border-left-color: #f59e0b;
        background: #fffbeb;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.95; }
    }
    
    .student-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .student-name {
        font-size: 1.2rem;
        font-weight: 600;
        color: #1f2937;
    }
    
    .student-email {
        color: #6b7280;
        font-size: 0.95rem;
        margin-top: 0.25rem;
    }
    
    .agent-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 0.75rem;
        margin-top: 1rem;
    }
    
    .agent-badge {
        padding: 0.5rem 0.75rem;
        border-radius: 5px;
        background: #f3f4f6;
        border: 1px solid #d1d5db;
        text-align: center;
        font-size: 0.85rem;
        color: #6b7280;
    }
    
    .agent-badge.working {
        background: #fef3c7;
        border-color: #fcd34d;
        color: #92400e;
        font-weight: 600;
    }
    
    .agent-badge.complete {
        background: #d1fae5;
        border-color: #6ee7b7;
        color: #065f46;
        font-weight: 600;
    }
    
    .results-link {
        margin-top: 1rem;
        padding: 0.75rem;
        background: #dbeafe;
        border-radius: 5px;
        text-decoration: none;
        color: #1e40af;
        font-weight: 600;
        display: inline-block;
        transition: background 0.2s;
    }
    
    .results-link:hover {
        background: #bfdbfe;
    }
    
    .submission-form {
        padding: 2rem;
        background: white;
        border-radius: 8px;
        border: 2px solid #e5e7eb;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-label {
        display: block;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #1f2937;
    }
    
    .form-description {
        color: #6b7280;
        font-size: 0.9rem;
        margin-top: 0.25rem;
    }
    
    .test-buttons {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }
    
    .btn-test {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        transition: background 0.2s;
    }
    
    .btn-test-quick {
        background: #667eea;
        color: white;
    }
    
    .btn-test-quick:hover {
        background: #5568d3;
    }
    
    .btn-test-custom {
        background: #10b981;
        color: white;
    }
    
    .btn-test-custom:hover {
        background: #059669;
    }
    
    .loading-spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 3px solid #f3f4f6;
        border-top-color: #667eea;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin-right: 0.5rem;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .status-empty {
        text-align: center;
        padding: 2rem;
        color: #6b7280;
    }
</style>
{% endblock %}

{% block content %}
<div class="test-view">
    <!-- Header -->
    <div class="card">
        <h2>üß™ Real-Time Test System</h2>
        <p style="color: #6b7280; margin-top: 0.5rem;">
            Submit test students and watch agents process them in real-time. Results appear only when all agents + Smee + Aurora complete.
        </p>
    </div>

    <!-- Submission Form -->
    <div class="submission-form">
        <h3 style="margin-bottom: 1.5rem;">Start a Test Run</h3>
        
        <div class="form-group">
            <label class="form-label">Choose Test Scenario</label>
            <p class="form-description">Select pre-defined test students to process</p>
            
            <div class="test-buttons">
                <button class="btn-test btn-test-quick" onclick="submitQuickTest('alex-jordan')">
                    ‚ö° Quick Test (Alex + Jordan)
                </button>
                <button class="btn-test btn-test-quick" onclick="submitQuickTest('alex-only')">
                    üìù Single Student (Alex)
                </button>
                <button class="btn-test btn-test-custom" onclick="submitQuickTest('custom')">
                    üéØ Custom Students
                </button>
            </div>
        </div>
    </div>

    <!-- Live Stream View -->
    <div id="stream-container" style="display: none;">
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3>üì° Live Processing Stream</h3>
                <button class="btn btn-secondary" onclick="resetStream()" style="padding: 0.5rem 1rem;">‚Ü∫ Reset</button>
            </div>
        </div>
        
        <div class="live-stream" id="live-stream">
            <div class="status-empty">
                <div class="loading-spinner"></div>
                <p>Waiting for students...</p>
            </div>
        </div>
    </div>

    <!-- Sample Results Info -->
    <div class="card" style="background: #f0f9ff; border-left: 4px solid #3b82f6;">
        <h3 style="color: #1e40af; margin-bottom: 1rem;">üìä Sample Results</h3>
        <p style="color: #1e40af; margin-bottom: 1rem;">View pre-computed sample results:</p>
        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <a href="{{ url_for('test_detail', student_id='alex') }}" class="btn btn-secondary">
                üë§ Alex Johnson (Complete)
            </a>
            <a href="{{ url_for('test_detail', student_id='jordan') }}" class="btn btn-secondary">
                üë§ Jordan Smith (Partial)
            </a>
        </div>
    </div>
</div>

<script>
const agents = ['tiana', 'rapunzel', 'moana', 'mulan', 'merlin', 'smee', 'aurora'];
const agentEmojis = {
    'tiana': 'üë∏',
    'rapunzel': 'üíá',
    'moana': 'üåä',
    'mulan': 'üó°Ô∏è',
    'merlin': 'üßô',
    'smee': 'üé©',
    'aurora': 'üëë'
};

function submitQuickTest(scenario) {
    let students = [];
    
    if (scenario === 'alex-jordan') {
        students = [
            {name: 'Alex Johnson', email: 'alex.johnson@example.com'},
            {name: 'Jordan Smith', email: 'jordan.smith@example.com'}
        ];
    } else if (scenario === 'alex-only') {
        students = [
            {name: 'Alex Johnson', email: 'alex.johnson@example.com'}
        ];
    } else if (scenario === 'custom') {
        // TODO: Show form to enter custom students
        alert('Custom student entry coming soon');
        return;
    }
    
    startTestRun(students);
}

function startTestRun(students) {
    // Show stream container
    document.getElementById('stream-container').style.display = 'block';
    const streamEl = document.getElementById('live-stream');
    streamEl.innerHTML = '';
    
    // Submit students for processing
    fetch('/api/test/submit', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({students: students})
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            streamEl.innerHTML = `<div class="card" style="background: #fee2e2; border-left: 4px solid #ef4444;"><p style="color: #991b1b;">${data.error}</p></div>`;
            return;
        }
        
        // Connect to SSE stream
        connectStream(data.stream_url);
    })
    .catch(e => {
        streamEl.innerHTML = `<div class="card" style="background: #fee2e2; border-left: 4px solid #ef4444;"><p style="color: #991b1b;">Error: ${e.message}</p></div>`;
    });
}

function connectStream(streamUrl) {
    const streamEl = document.getElementById('live-stream');
    const studentCards = {};  // Track student cards by ID
    
    const eventSource = new EventSource(streamUrl);
    
    eventSource.onmessage = (event) => {
        try {
            const msg = JSON.parse(event.data);
            
            if (msg.type === 'connected') {
                streamEl.innerHTML = '';
            }
            
            else if (msg.type === 'student_submitted') {
                // Create student card
                const studentId = msg.student_id;
                const student = msg.student;
                
                const card = document.createElement('div');
                card.className = 'student-card processing';
                card.id = `card-${studentId}`;
                card.innerHTML = `
                    <div class="student-header">
                        <div>
                            <div class="student-name">${student.name}</div>
                            <div class="student-email">${student.email}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1rem;">üì•</div>
                            <div style="font-size: 0.8rem; color: #6b7280;">Submitted</div>
                        </div>
                    </div>
                    <div class="agent-list" id="agents-${studentId}">
                        ${agents.map(a => `<div class="agent-badge" id="agent-${studentId}-${a}">${agentEmojis[a]} ${a}</div>`).join('')}
                    </div>
                `;
                
                streamEl.appendChild(card);
                studentCards[studentId] = card;
            }
            
            else if (msg.type === 'agent_start') {
                const agentEl = document.getElementById(`agent-${msg.student_id}-${msg.agent}`);
                if (agentEl) {
                    agentEl.className = 'agent-badge working';
                    agentEl.innerHTML = `<span class="loading-spinner"></span>${agentEmojis[msg.agent]} ${msg.agent}`;
                }
            }
            
            else if (msg.type === 'agent_complete') {
                const agentEl = document.getElementById(`agent-${msg.student_id}-${msg.agent}`);
                if (agentEl) {
                    agentEl.className = 'agent-badge complete';
                    agentEl.innerHTML = `‚úÖ ${agentEmojis[msg.agent]} ${msg.agent}`;
                }
            }
            
            else if (msg.type === 'results_ready') {
                // Update card to show complete + link to results
                const card = document.getElementById(`card-${msg.student_id}`);
                if (card) {
                    card.className = 'student-card complete';
                    
                    // Add results link
                    const link = document.createElement('a');
                    link.href = msg.results_url;
                    link.className = 'results-link';
                    link.innerHTML = 'üìä View Complete Results ‚Üí';
                    card.appendChild(link);
                }
            }
        } catch (e) {
            console.error('Error parsing SSE message:', e);
        }
    };
    
    eventSource.onerror = (e) => {
        console.error('Stream error:', e);
        eventSource.close();
        
        const statusMsg = document.createElement('div');
        statusMsg.className = 'card';
        statusMsg.style.background = '#d1fae5';
        statusMsg.style.borderLeft = '4px solid #10b981';
        statusMsg.innerHTML = '<p style="color: #065f46;"><strong>‚úÖ Test run complete!</strong> All students have been processed.</p>';
        streamEl.appendChild(statusMsg);
    };
}

function resetStream() {
    document.getElementById('stream-container').style.display = 'none';
    document.getElementById('live-stream').innerHTML = '';
}

// Scroll stream to bottom when new content added
const observer = new MutationObserver(() => {
    const stream = document.getElementById('live-stream');
    if (stream) {
        stream.scrollTop = stream.scrollHeight;
    }
});

observer.observe(document.getElementById('live-stream') || document.body, {
    childList: true,
    subtree: true
});
</script>

{% endblock %}
{% extends "base.html" %}

{% block title %}Real-Time Test System{% endblock %}

{% block extra_css %}
<style>
    .test-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
    }

    .test-header {
        margin-bottom: 2rem;
    }

    .start-test-section {
        background: white;
        padding: 1.5rem;
        border-radius: 8px;
        border-left: 4px solid #667eea;
        margin-bottom: 2rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .btn-start-test {
        background: #667eea;
        color: white;
        padding: 0.75rem 2rem;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        font-size: 1rem;
        transition: background 0.2s;
    }

    .btn-start-test:hover {
        background: #5568d3;
    }

    .btn-start-test:disabled {
        background: #ccc;
        cursor: not-allowed;
    }

    .table-section {
        background: white;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .table-header {
        padding: 1.5rem;
        border-bottom: 2px solid #e5e7eb;
        background: #f9fafb;
    }

    .table-header h3 {
        margin: 0;
        color: #1f2937;
    }

    .students-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.95rem;
    }

    .students-table thead {
        background: #f3f4f6;
        border-bottom: 2px solid #d1d5db;
    }

    .students-table th {
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        color: #374151;
    }

    .students-table tbody tr {
        border-bottom: 1px solid #e5e7eb;
        transition: background 0.2s;
    }

    .students-table tbody tr:hover {
        background: #f9fafb;
    }

    .students-table td {
        padding: 1rem;
    }

    .student-name {
        font-weight: 600;
        color: #1f2937;
    }

    .badge {
        display: inline-block;
        padding: 0.3rem 0.6rem;
        border-radius: 4px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .badge-pending {
        background: #fef3c7;
        color: #92400e;
    }

    .badge-processing {
        background: #d1fae5;
        color: #065f46;
    }

    .badge-complete {
        background: #10b981;
        color: white;
    }

    .badge-error {
        background: #fee2e2;
        color: #991b1b;
    }

    .badge-waiting {
        background: #fef3c7;
        color: #92400e;
    }

    .agent-steps {
        display: flex;
        gap: 0.25rem;
        flex-wrap: wrap;
    }

    .agent-step {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #e5e7eb;
        color: #6b7280;
        font-size: 0.75rem;
        font-weight: 600;
        position: relative;
        cursor: help;
    }

    .agent-step.working {
        background: #10b981;
        color: white;
        animation: pulse 1s infinite;
    }

    .agent-step.waiting {
        background: #fef3c7;
        color: #92400e;
    }

    .agent-step.complete {
        background: #059669;
        color: white;
    }

    .agent-step.error {
        background: #ef4444;
        color: white;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }

    .loading-spinner {
        display: inline-block;
        width: 14px;
        height: 14px;
        border: 2px solid #f3f4f6;
        border-top-color: #667eea;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin-right: 0.5rem;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .status-message {
        padding: 1rem;
        text-align: center;
        color: #6b7280;
    }

    .waiting-detail {
        margin-top: 0.35rem;
        font-size: 0.8rem;
        color: #92400e;
        background: #fef3c7;
        border-radius: 4px;
        padding: 0.2rem 0.4rem;
        display: inline-block;
    }

    .empty-state {
        padding: 3rem;
        text-align: center;
        color: #9ca3af;
    }

    .completion-rate {
        font-size: 0.85rem;
        color: #6b7280;
    }

    .result-link {
        color: #0ea5e9;
        text-decoration: none;
        font-weight: 600;
    }

    .result-link:hover {
        text-decoration: underline;
    }

    .info-box {
        background: #eff6ff;
        border-left: 4px solid #0284c7;
        padding: 1rem;
        border-radius: 4px;
        margin-bottom: 1.5rem;
        font-size: 0.95rem;
        color: #0c4a6e;
    }

    @media (max-width: 768px) {
        .test-container {
            padding: 1rem;
        }
        
        .agents-table {
            font-size: 0.8rem;
        }
        
        .agent-step {
            width: 28px;
            height: 28px;
        }
    }
    .test-view {
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }
    
    .live-stream {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        max-height: 70vh;
        overflow-y: auto;
        padding: 1.5rem;
        background: #f9fafb;
        border-radius: 8px;
        border: 2px solid #e5e7eb;
    }
    
    .student-card {
        padding: 1.5rem;
        background: white;
        border-radius: 8px;
        border-left: 4px solid #3b82f6;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .student-card.complete {
        border-left-color: #10b981;
        background: #f0fdf4;
    }
    
    .student-card.processing {
        border-left-color: #f59e0b;
        background: #fffbeb;
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.95; }
    }
    
    .student-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .student-name {
        font-size: 1.2rem;
        font-weight: 600;
        color: #1f2937;
    }
    
    .student-email {
        color: #6b7280;
        font-size: 0.95rem;
        margin-top: 0.25rem;
    }
    
    .agent-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 0.75rem;
        margin-top: 1rem;
    }
    
    .agent-badge {
        padding: 0.5rem 0.75rem;
        border-radius: 5px;
        background: #f3f4f6;
        border: 1px solid #d1d5db;
        text-align: center;
        font-size: 0.85rem;
        color: #6b7280;
    }
    
    .agent-badge.working {
        background: #d1fae5;
        border-color: #6ee7b7;
        color: #065f46;
        font-weight: 600;
    }

    .agent-badge.waiting {
        background: #fef3c7;
        border-color: #fcd34d;
        color: #92400e;
        font-weight: 600;
    }
    
    .agent-badge.complete {
        background: #d1fae5;
        border-color: #6ee7b7;
        color: #065f46;
        font-weight: 600;
    }
    
    .agent-badge.error {
        background: #fee2e2;
        border-color: #fca5a5;
        color: #991b1b;
        font-weight: 600;
    }
    
    @keyframes dots {
        0%, 20%, 50%, 80%, 100% {
            opacity: 1;
        }
        40% {
            opacity: 0.5;
        }
        60% {
            opacity: 0.3;
        }
    }
    
    .results-link {
        margin-top: 1rem;
        padding: 0.75rem;
        background: #dbeafe;
        border-radius: 5px;
        text-decoration: none;
        color: #1e40af;
        font-weight: 600;
        display: inline-block;
        transition: background 0.2s;
    }
    
    .results-link:hover {
        background: #bfdbfe;
    }
    
    .submission-form {
        padding: 2rem;
        background: white;
        border-radius: 8px;
        border: 2px solid #e5e7eb;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-label {
        display: block;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #1f2937;
    }
    
    .form-description {
        color: #6b7280;
        font-size: 0.9rem;
        margin-top: 0.25rem;
    }
    
    .test-buttons {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }
    
    .btn-test {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 600;
        transition: background 0.2s;
    }
    
    .btn-test-quick {
        background: #667eea;
        color: white;
    }
    
    .btn-test-quick:hover {
        background: #5568d3;
    }
    
    .btn-test-custom {
        background: #10b981;
        color: white;
    }
    
    .btn-test-custom:hover {
        background: #059669;
    }
    
    .loading-spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 3px solid #f3f4f6;
        border-top-color: #667eea;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin-right: 0.5rem;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .status-empty {
        text-align: center;
        padding: 2rem;
        color: #6b7280;
    }
</style>
{% endblock %}

{% block content %}
<div class="test-container">
    <!-- Header -->
    <div class="test-header">
        <h1>üß™ Real-Time Test System</h1>
        <p style="color: #6b7280; margin-top: 0.5rem;">
            Test the full 9-step evaluation pipeline: Extract ‚Üí Match ‚Üí Enrich ‚Üí Validate ‚Üí Evaluate ‚Üí Synthesize ‚Üí Report
        </p>
    </div>

    <!-- Info Box -->
    <div class="info-box">
        üìã <strong>9-Step Workflow - What we're testing:</strong>
        <br/>1Ô∏è‚É£ üìñ <strong>BELLE</strong> - Extract student info from documents (name, school, grades, test scores)
        <br/>2Ô∏è‚É£ üîç <strong>Student Matching</strong> - Find existing student or create new record (composite key: name + school + state)
        <br/>2Ô∏è‚É£‚ûï üè´ <strong>High School Pre-Enrichment Check</strong> - Validate/enrich school data before validation loop
        <br/>3Ô∏è‚É£ üßë‚Äçüî¨ <strong>NAVEEN</strong> - Enrich school record with demographic + resource data (AP counts, free lunch %)
        <br/>3Ô∏è‚É£‚ûï üîÑ <strong>School Validation Loop (NAVEEN ‚Üî MOANA)</strong> - Bidirectional validation with up to 2 remediation attempts
        <br/>&nbsp;&nbsp;&nbsp;&nbsp;‚îî‚îÄ üë∏ <strong>TIANA</strong> - Application essay analysis
        <br/>&nbsp;&nbsp;&nbsp;&nbsp;‚îî‚îÄ üëë <strong>RAPUNZEL</strong> - Grade/transcript analysis with contextual rigor weighting (0-5 scale based on school's AP/Honors availability)
        <br/>&nbsp;&nbsp;&nbsp;&nbsp;‚îî‚îÄ üåä <strong>MOANA</strong> - School context & fairness weighting
        <br/>&nbsp;&nbsp;&nbsp;&nbsp;‚îî‚îÄ ü•ã <strong>MULAN</strong> - Recommendation letter synthesis
        <br/>5Ô∏è‚É£ üìä <strong>MILO</strong> - Pattern analysis across student profile
        <br/>6Ô∏è‚É£ üßô <strong>MERLIN</strong> - Comprehensive evaluation (score + recommendation)
        <br/>7Ô∏è‚É£ ‚ú® <strong>AURORA</strong> - Executive summary & formatted evaluation report
        <br/><br/><strong>Result:</strong> Complete multi-agent evaluation with academic context, audit trail logging, and fairness weighting
        <br/><strong>Audit Trail:</strong> 14 interaction types logged to database for compliance verification
    </div>

    <!-- Start Test Section -->
    <div class="start-test-section">
        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <div>
                <h4 style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: #6b7280;">üé≤ Random Fake Applications</h4>
                <button class="btn-start-test" id="btnStartTest" onclick="startTest('dynamic')" style="background: #667eea;">
                    üöÄ Random Students
                </button>
                <p style="font-size: 0.8rem; color: #9ca3af; margin: 0.5rem 0 0 0;">Generate new synthetic data each run</p>
            </div>
            <div>
                <h4 style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: #6b7280;">üìã Fixed Fake Applications</h4>
                <button class="btn-start-test" id="btnPreset" onclick="startTest('preset')" style="background: #10b981;">
                    ‚ö° Preset Students
                </button>
                <p style="font-size: 0.8rem; color: #9ca3af; margin: 0.5rem 0 0 0;">Same 3 students (Alice, Brian, Carol)</p>
            </div>
            <div>
                <h4 style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: #6b7280;">‚ö° Quick Test</h4>
                <button class="btn-start-test" id="btnSingle" onclick="startTest('single')" style="background: #f59e0b;">
                    ‚ö° Single Student
                </button>
                <p style="font-size: 0.8rem; color: #9ca3af; margin: 0.5rem 0 0 0;">Just Alice ‚Äì fastest testing</p>
            </div>
            <div>
                <h4 style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: #6b7280;">üóëÔ∏è Manage Test Data</h4>
                <button class="btn-start-test" id="btnClearData" onclick="clearTestData()" style="background: #ef4444;">
                    üóëÔ∏è Clear Test Data
                </button>
                <p style="font-size: 0.8rem; color: #9ca3af; margin: 0.5rem 0 0 0;">Delete all test students to start fresh</p>
            </div>
        </div>
        <span id="testStatus" style="margin-left: 1rem; color: #6b7280;"></span>
    </div>

    <!-- Upload Real Files Section -->
    <div class="start-test-section" style="border-left: 4px solid #3b82f6;">
        <h3 style="margin: 0 0 1rem 0; color: #1e40af;">üìÅ Upload Real Test Files</h3>
        <p style="color: #6b7280; margin-bottom: 1rem; font-size: 0.9rem;">
            Upload actual application files (PDF, DOCX, TXT) to test how well the agents perform with real data.
            Multiple files for the same student (including multiple recommendation letters) will be combined.
        </p>
        
        <form id="uploadTestForm" enctype="multipart/form-data" style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 300px;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: #1f2937;">
                    Select File(s):
                </label>
                <input type="file" 
                       id="testFileInput" 
                       name="files" 
                       multiple
                       accept=".pdf,.docx,.doc,.txt"
                       style="width: 100%; padding: 0.5rem; border: 2px solid #3b82f6; border-radius: 5px; cursor: pointer;">
                <p id="fileCount" style="font-size: 0.85rem; color: #6b7280; margin: 0.5rem 0 0 0;"></p>
            </div>
            
            <div style="display: flex; gap: 0.5rem; align-items: flex-end;">
                <button type="button" 
                        class="btn-start-test" 
                        id="btnUploadTest" 
                        onclick="uploadTestFiles()"
                        style="background: #3b82f6;">
                    üì§ Upload & Test
                </button>
                <button type="button" 
                        class="btn-start-test" 
                        onclick="document.getElementById('testFileInput').value = ''; updateFileCount();"
                        style="background: #6b7280; padding: 0.75rem 1rem;">
                    Clear
                </button>
            </div>
        </form>
        
        <div id="uploadProgress" style="display: none; margin-top: 1rem; padding: 1rem; background: #f0f9ff; border-radius: 5px; border-left: 4px solid #3b82f6;">
            <span id="uploadProgressText"></span>
        </div>
    </div>

    <!-- Students Table -->
    <div class="table-section">
        <div class="table-header">
            <h3>ÔøΩ Test Applications & Evaluation Status <span id="completionRate" class="completion-rate"></span></h3>
            <p style="font-size: 0.9rem; color: #6b7280; margin: 0.5rem 0 0 0;">
                Synthetic applications stored in database ‚Üí Evaluation pipeline runs ‚Üí Results saved
            </p>
        </div>
        
        <table class="students-table">
            <thead>
                <tr>
                    <th style="width: 25%;">Candidate Name</th>
                    <th style="width: 15%;">Analysis Status</th>
                    <th style="width: 45%;">Steps Completed</th>
                    <th style="width: 15%;">View Summary</th>
                </tr>
            </thead>
            <tbody id="studentTableBody">
                <tr>
                    <td colspan="4" class="empty-state">
                        Click "Start Test Run" to begin processing students
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
const agentNames = {
    'smee': 'Orchestration',
    'belle': 'Document intake',
    'tiana': 'Application review',
    'rapunzel': 'Transcript with contextual rigor',
    'naveen': 'School enrichment',
    'moana': 'School validation & fairness weighting',
    'mulan': 'Recommendation analysis',
    'milo': 'Pattern analysis',
    'merlin': 'Comprehensive evaluation',
    'aurora': 'Executive summary'
};

const agentEmojis = {
    'smee': 'üé©',
    'belle': 'üìñ',
    'tiana': 'üë∏',
    'rapunzel': 'üëë',
    'naveen': 'üßë‚Äçüî¨',
    'moana': 'üåä',
    'mulan': 'ü•ã',
    'milo': 'üìä',
    'merlin': 'üßô',
    'aurora': '‚ú®'
};

let students = {};
let totalStudents = 0;
let completedStudents = 0;
let eventSource = null;
let pollInterval = null;

function startTest(type = 'dynamic') {
    const btn = document.getElementById('btnStartTest');
    const btnPreset = document.getElementById('btnPreset');
    const btnSingle = document.getElementById('btnSingle');
    const status = document.getElementById('testStatus');
    
    btn.disabled = true;
    btnPreset.disabled = true;
    btnSingle.disabled = true;
    status.innerHTML = '<span class="loading-spinner"></span>Generating test students...';
    
    // Clear previous data
    students = {};
    totalStudents = 0;
    completedStudents = 0;
    
    // Clear any existing poll interval
    if (pollInterval) clearInterval(pollInterval);
    
    document.getElementById('studentTableBody').innerHTML = '';
    
    // Choose endpoint based on type
    const endpoint = type === 'preset' ? '/api/test/submit-preset' 
                   : type === 'single' ? '/api/test/submit-single'
                   : '/api/test/submit';
    
    fetch(endpoint, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            status.innerHTML = `‚ùå Error: ${data.error}`;
            btn.disabled = false;
            btnPreset.disabled = false;
            btnSingle.disabled = false;
            return;
        }
        
        totalStudents = data.student_count || 0;
        let testType = 'Random';
        if (type === 'preset') testType = 'Preset (3 students)';
        else if (type === 'single') testType = 'Single (Alice)';
        
        if (totalStudents === 0) {
            status.innerHTML = '<span class="loading-spinner"></span>Preparing test students...';
        } else {
            status.innerHTML = '<span class="loading-spinner"></span>Processing ' + totalStudents + ' ' + testType + ' student(s)...';
        }
        
        // Start polling the database for student status (every 1 second for faster updates)
        pollStudentStatus();
        if (!pollInterval) {
            pollInterval = setInterval(pollStudentStatus, 1000);
        }
        
        // Also connect SSE for real-time updates (as backup)
        connectStream(data.stream_url);
    })
    .catch(e => {
        status.innerHTML = `‚ùå Error: ${e.message}`;
        btn.disabled = false;
        btnPreset.disabled = false;
        btnSingle.disabled = false;
    });
}

function pollStudentStatus() {
    // Fetch current test students from database
    fetch('/api/test/students')
        .then(r => r.json())
        .then(data => {
            if (data.status === 'success' && data.students) {
                // Update students dict with fresh data from database
                data.students.forEach(student => {
                    students[`app_${student.application_id}`] = {
                        id: `app_${student.application_id}`,
                        name: student.name,
                        status: student.status,
                        applicationId: student.application_id,
                        agentProgress: student.agent_progress
                    };
                });
                
                completedStudents = data.students.filter(s => s.status === 'complete').length;
                renderTable();
                
                // Stop polling if all done
                if (completedStudents >= totalStudents && totalStudents > 0) {
                    if (pollInterval) clearInterval(pollInterval);
                    document.getElementById('testStatus').innerHTML = '‚úÖ Test complete! All students processed.';
                    document.getElementById('btnStartTest').disabled = false;
                    document.getElementById('btnPreset').disabled = false;
                    document.getElementById('btnSingle').disabled = false;
                }
            }
        })
        .catch(e => console.error('Poll error:', e));
    
    // Poll every 2 seconds
    if (!pollInterval) {
        pollInterval = setInterval(pollStudentStatus, 2000);
    }
}

function connectStream(streamUrl) {
    const status = document.getElementById('testStatus');
    
    if (eventSource) {
        eventSource.close();
    }
    
    eventSource = new EventSource(streamUrl);
    
    eventSource.onmessage = (event) => {
        try {
            const msg = JSON.parse(event.data);
            handleStreamMessage(msg);
        } catch (e) {
            console.error('Parse error:', e);
        }
    };
    
    eventSource.onerror = (e) => {
        eventSource.close();
        status.innerHTML = '‚ö†Ô∏è Stream paused. Switching to polling...';
        pollStudentStatus();
    };
}

function handleStreamMessage(msg) {
    const status = document.getElementById('testStatus');
    const tableBody = document.getElementById('studentTableBody');
    
    if (msg.type === 'connected') {
        status.innerHTML = '<span class="loading-spinner"></span>Processing students...';
    }
    
    else if (msg.type === 'student_count') {
        // generator finished, update total count
        totalStudents = msg.count || totalStudents;
        status.innerHTML = '<span class="loading-spinner"></span>Processing ' + totalStudents + ' student(s)...';
    }
    
    else if (msg.type === 'student_submitted') {
        const studentId = msg.student_id || `app_${msg.application_id}`;
        students[studentId] = {
            id: studentId,
            name: msg.student?.name || 'Student',
            status: 'processing',
            applicationId: msg.application_id || null,
            waitingFields: [],
            waitingByAgent: {},
            agentProgress: {
                'smee': 'starting',
                'belle': 'starting',
                'application_reader': 'pending',
                'grade_reader': 'pending',
                'recommendation_reader': 'pending',
                'school_context': 'pending',
                'student_evaluator': 'pending',
                'aurora': 'pending',
                'fairy_godmother': 'pending'
            }
        };
        renderTable();
    }

    else if (msg.type === 'student_start') {
        const studentId = msg.student_id || `app_${msg.application_id}`;
        if (!students[studentId]) {
            students[studentId] = {
                id: studentId,
                name: msg.applicant_name,
                status: 'processing',
                applicationId: msg.application_id || null,
                waitingFields: [],
                waitingByAgent: {},
                agentProgress: {
                    'smee': 'starting',
                    'belle': 'starting',
                    'application_reader': 'pending',
                    'grade_reader': 'pending',
                    'recommendation_reader': 'pending',
                    'school_context': 'pending',
                    'student_evaluator': 'pending',
                    'aurora': 'pending',
                    'fairy_godmother': 'pending'
                }
            };
        } else if (msg.application_id) {
            students[studentId].applicationId = msg.application_id;
        }
        renderTable();
    }
    
    else if (msg.type === 'agent_progress') {
        const studentId = msg.student_id
            || (msg.application_id ? `app_${msg.application_id}` : null)
            || Object.keys(students).find(id => students[id].name === msg.applicant);
        
        if (studentId) {
            const agent = msg.agent_id;
            const progressStatus = msg.status;
            
            if (!students[studentId].agentProgress[agent]) {
                students[studentId].agentProgress[agent] = 'pending';
            }
            students[studentId].agentProgress[agent] = progressStatus;
            if (progressStatus === 'blocked' || progressStatus === 'asking_for_info') {
                students[studentId].status = 'waiting';
            }
            if (msg.waiting_for) {
                students[studentId].waitingByAgent[agent] = msg.waiting_for;
            }
            renderTable();
        }
    }

    else if (msg.type === 'evaluation_paused') {
        const studentId = msg.student_id || Object.keys(students).find(id =>
            students[id].name === msg.applicant
        );

        if (studentId && students[studentId]) {
            students[studentId].status = 'waiting';
            students[studentId].waitingFields = msg.missing_fields || [];
            if (Array.isArray(msg.agent_questions)) {
                msg.agent_questions.forEach((agentInfo) => {
                    const fieldName = agentInfo.field_name;
                    if (fieldName) {
                        students[studentId].waitingByAgent[agentInfo.agent_id] = fieldName;
                    }
                });
            }
            if (students[studentId].agentProgress.smee) {
                students[studentId].agentProgress.smee = 'waiting';
            }
            renderTable();
        }
    }
    
    else if (msg.type === 'student_complete') {
        completedStudents++;
        
        const studentId = msg.student_id || `app_${msg.application_id}`;
        if (students[studentId]) {
            students[studentId].status = 'complete';
            students[studentId].applicationId = msg.application_id;
        }
        
        updateCompletionRate();
        renderTable();
    }
    
    else if (msg.type === 'student_error') {
        const studentId = msg.student_id;
        if (students[studentId]) {
            students[studentId].status = 'error';
        }
        renderTable();
    }
    
    else if (msg.type === 'all_complete') {
        status.innerHTML = '‚úÖ Test complete! All students processed.';
        document.getElementById('btnStartTest').disabled = false;
        document.getElementById('btnSingle').disabled = false;
        eventSource.close();
    }
}

function updateCompletionRate() {
    const rate = document.getElementById('completionRate');
    if (totalStudents > 0) {
        const pct = Math.round((completedStudents / totalStudents) * 100);
        rate.textContent = `(${completedStudents}/${totalStudents} completed - ${pct}%)`;
    }
}

function renderTable() {
    const tableBody = document.getElementById('studentTableBody');
    
    if (Object.keys(students).length === 0) {
        tableBody.innerHTML = '<tr><td colspan="4" class="empty-state">No students yet</td></tr>';
        return;
    }
    
    let html = '';
    for (const studentId in students) {
        const student = students[studentId];
        const statusBadge = `badge-${student.status}`;
        const statusLabel = student.status.charAt(0).toUpperCase() + student.status.slice(1);
        
        let agentSteps = '';
        for (const agent of Object.keys(agentNames)) {
            const rawProgress = student.agentProgress[agent];
            const progress = normalizeAgentStatus(rawProgress);
            let stepClass = 'agent-step';
            if (progress === 'working') stepClass += ' working';
            else if (progress === 'complete') stepClass += ' complete';
            else if (progress === 'error') stepClass += ' error';
            else if (progress === 'waiting') stepClass += ' waiting';

            const waitingFor = student.waitingByAgent?.[agent];
            const tooltip = waitingFor
                ? `${agentNames[agent]} - ${progress} (waiting for ${waitingFor})`
                : `${agentNames[agent]} - ${progress}`;
            agentSteps += `<div class="${stepClass}" title="${tooltip}">${agentEmojis[agent]}</div>`;
        }

        let waitingDetail = '';
        if (student.status === 'waiting') {
            const waitingItems = student.waitingFields?.length
                ? student.waitingFields
                : Object.values(student.waitingByAgent || {});
            const uniqueWaiting = [...new Set(waitingItems)].filter(Boolean);
            if (uniqueWaiting.length) {
                waitingDetail = `<div class="waiting-detail">Waiting for: ${uniqueWaiting.join(', ')}</div>`;
            }
        }
        
        let actionBtn = '';
        if (student.status === 'complete' && student.applicationId) {
            actionBtn = `<a href="/application/${student.applicationId}" class="result-link">View Results ‚Üí</a>`;
        } else if (student.status === 'error') {
            actionBtn = '<span style="color: #ef4444;">‚ùå Failed</span>';
        } else {
            actionBtn = '<span style="color: #9ca3af;"><span class="loading-spinner"></span>Processing...</span>';
        }
        
        html += `
            <tr>
                <td class="student-name">${student.name}</td>
                <td><span class="badge ${statusBadge}">${statusLabel}</span></td>
                <td>
                    <div class="agent-steps">${agentSteps}</div>
                    ${waitingDetail}
                </td>
                <td>${actionBtn}</td>
            </tr>
        `;
    }
    
    tableBody.innerHTML = html;
    updateCompletionRate();
}

function normalizeAgentStatus(status) {
    if (!status) return 'waiting';
    const normalized = String(status).toLowerCase();
    if (normalized === 'starting' || normalized === 'working') return 'working';
    if (normalized === 'completed' || normalized === 'complete' || normalized === 'success') return 'complete';
    if (normalized === 'failed' || normalized === 'error') return 'error';
    if (normalized === 'blocked' || normalized === 'waiting' || normalized === 'pending' || normalized === 'asking_for_info') return 'waiting';
    return normalized;
}

function clearTestData() {
    if (!confirm('Are you sure you want to delete all test data? This cannot be undone.')) {
        return;
    }
    
    const btnClear = document.getElementById('btnClearData');
    btnClear.disabled = true;
    btnClear.textContent = 'üóëÔ∏è Clearing...';
    
    fetch('/api/test/cleanup', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(r => r.json())
    .then(data => {
        if (data.status === 'success') {
            const remaining = data.remaining_test_apps ?? 0;
            alert(`‚úÖ Test data cleaned. Remaining test applications: ${remaining}`);
            students = {};
            totalStudents = 0;
            completedStudents = 0;
            renderTable();
        } else {
            alert(`‚ùå Error: ${data.error}`);
        }
        btnClear.disabled = false;
        btnClear.textContent = 'üóëÔ∏è Clear Test Data';
    })
    .catch(e => {
        alert(`‚ùå Error: ${e.message}`);
        btnClear.disabled = false;
        btnClear.textContent = 'üóëÔ∏è Clear Test Data';
    });
}

function updateFileCount() {
    const fileInput = document.getElementById('testFileInput');
    const fileCount = document.getElementById('fileCount');
    const count = fileInput.files.length;
    
    if (count === 0) {
        fileCount.textContent = '';
    } else if (count === 1) {
        fileCount.textContent = `‚úì ${fileInput.files[0].name}`;
    } else {
        fileCount.textContent = `‚úì ${count} files selected`;
    }
}

async function uploadTestFiles() {
    const fileInput = document.getElementById('testFileInput');
    const btnUpload = document.getElementById('btnUploadTest');
    const uploadProgress = document.getElementById('uploadProgress');
    const uploadProgressText = document.getElementById('uploadProgressText');
    
    if (fileInput.files.length === 0) {
        alert('Please select at least one file to upload');
        return;
    }
    
    btnUpload.disabled = true;
    btnUpload.innerHTML = '‚è≥ Uploading...';
    uploadProgress.style.display = 'block';
    uploadProgressText.textContent = 'Uploading files...';
    
    const formData = new FormData();
    for (let i = 0; i < fileInput.files.length; i++) {
        formData.append('files', fileInput.files[i]);
    }
    
    try {
        const response = await fetch('/api/test/upload-files', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            uploadProgressText.innerHTML = `‚úÖ Uploaded ${result.count} file(s)<br/>üìä Processing with agents...`;
            
            // Clear file input
            fileInput.value = '';
            updateFileCount();
            
            // Reset table and connect to realtime stream
            students = {};
            totalStudents = result.count || 0;
            completedStudents = 0;
            renderTable();

            if (result.session_id) {
                const streamUrl = result.stream_url;
                connectStream(streamUrl);
                pollStudentStatus();
                if (!pollInterval) {
                    pollInterval = setInterval(pollStudentStatus, 1000);
                }
            } else {
                // No stream available, just show success
                setTimeout(() => {
                    uploadProgress.style.display = 'none';
                    btnUpload.disabled = false;
                    btnUpload.innerHTML = 'üì§ Upload & Test';
                    loadPersistentTestData(); // Reload to show new students
                }, 2000);
            }
        } else {
            uploadProgressText.textContent = `‚ùå Error: ${result.error}`;
            btnUpload.disabled = false;
            btnUpload.innerHTML = 'üì§ Upload & Test';
        }
    } catch (error) {
        uploadProgressText.textContent = `‚ùå Upload failed: ${error.message}`;
        btnUpload.disabled = false;
        btnUpload.innerHTML = 'üì§ Upload & Test';
    }
}

function handleStreamUpdate(msg) {
    handleStreamMessage(msg);
}

function loadPersistentTestData() {
    fetch('/api/test-data/list')
    .then(r => r.json())
    .then(data => {
        if (data.status === 'success' && data.students && data.students.length > 0) {
            // Load existing test data
            students = {};
            data.students.forEach((student, idx) => {
                const studentId = `student_${idx}`;
                students[studentId] = {
                    id: studentId,
                    name: student.applicantname || student.ApplicantName || `Student ${student.applicationid}`,
                    status: student.status?.toLowerCase() === 'pending' ? 'processing' : (student.status?.toLowerCase() === 'evaluated' ? 'complete' : 'processing'),
                    applicationId: student.applicationid || student.ApplicationID,
                    agentProgress: {
                        'application_reader': 'complete',
                        'grade_reader': 'complete',
                        'recommendation_reader': 'complete',
                        'school_context': 'complete',
                        'student_evaluator': student.merlin_score ? 'complete' : 'pending'
                    }
                };
            });
            
            totalStudents = data.count;
            completedStudents = Object.values(students).filter(s => s.status === 'complete').length;
            renderTable();
            
            if (data.count > 0) {
                document.getElementById('testStatus').innerHTML = `üìä Loaded ${data.count} test students from database`;
            }
        }
    })
    .catch(e => {
        console.log('No persistent test data found:', e);
    });
}

// Load persistent test data when page loads
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('testFileInput');
    if (fileInput) {
        fileInput.addEventListener('change', updateFileCount);
    }
    loadPersistentTestData();
});
</script>

{% endblock %}
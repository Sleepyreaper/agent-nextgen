{% extends "base.html" %}

{% block title %}Application Details{% endblock %}

{% block content %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2>Application #{{ application.ApplicationID }}</h2>
        <a href="{{ url_for('index') }}" class="btn btn-secondary">‚Üê Back to Dashboard</a>
    </div>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
        <div>
            <h3>üìã Applicant Information</h3>
            <table style="margin-top: 1rem;">
                <tr>
                    <th style="width: 40%;">Name:</th>
                    <td>{{ application.ApplicantName }}</td>
                </tr>
                <tr>
                    <th>Email:</th>
                    <td>{{ application.Email or 'N/A' }}</td>
                </tr>
                <tr>
                    <th>Position:</th>
                    <td>{{ application.Position or 'N/A' }}</td>
                </tr>
                <tr>
                    <th>Uploaded:</th>
                    <td>{{ application.UploadedDate.strftime('%Y-%m-%d %H:%M') if application.UploadedDate else 'N/A' }}</td>
                </tr>
                <tr>
                    <th>Status:</th>
                    <td><span class="badge badge-{{ application.Status.lower() }}">{{ application.Status }}</span></td>
                </tr>
            </table>
        </div>

        {% if evaluation %}
        <div>
            <h3>ü§ñ AI Evaluation</h3>
            <div style="margin-top: 1rem;">
                {% if evaluation.OverallScore %}
                <div style="font-size: 3rem; font-weight: bold; color: #667eea; text-align: center;">
                    {{ "%.1f"|format(evaluation.OverallScore) }}
                </div>
                <div style="text-align: center; color: #6b7280; margin-top: 0.5rem;">
                    Overall Score / 100
                </div>
                {% endif %}
                {% if evaluation.Recommendation %}
                <div style="text-align: center; margin-top: 1rem;">
                    <span class="badge" style="background: #667eea; color: white; padding: 0.5rem 1rem; font-size: 1rem;">
                        {{ evaluation.Recommendation }}
                    </span>
                </div>
                {% endif %}
                {% if evaluation.Confidence %}
                <div style="text-align: center; margin-top: 0.5rem; color: #6b7280;">
                    Confidence: {{ evaluation.Confidence }}
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    {% if evaluation %}
    {% if evaluation.TechnicalSkillsScore or evaluation.CommunicationScore or evaluation.ExperienceScore or evaluation.CulturalFitScore %}
    <div style="background: #f9fafb; padding: 1.5rem; border-radius: 5px; margin-bottom: 2rem;">
        <h3>üìä Detailed Scores</h3>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-top: 1rem;">
            {% if evaluation.TechnicalSkillsScore %}
            <div style="text-align: center;">
                <div style="font-size: 1.5rem; font-weight: bold; color: #667eea;">
                    {{ "%.0f"|format(evaluation.TechnicalSkillsScore) }}
                </div>
                <div style="color: #6b7280; font-size: 0.875rem;">Technical Skills</div>
            </div>
            {% endif %}
            {% if evaluation.CommunicationScore %}
            <div style="text-align: center;">
                <div style="font-size: 1.5rem; font-weight: bold; color: #10b981;">
                    {{ "%.0f"|format(evaluation.CommunicationScore) }}
                </div>
                <div style="color: #6b7280; font-size: 0.875rem;">Communication</div>
            </div>
            {% endif %}
            {% if evaluation.ExperienceScore %}
            <div style="text-align: center;">
                <div style="font-size: 1.5rem; font-weight: bold; color: #f59e0b;">
                    {{ "%.0f"|format(evaluation.ExperienceScore) }}
                </div>
                <div style="color: #6b7280; font-size: 0.875rem;">Experience</div>
            </div>
            {% endif %}
            {% if evaluation.CulturalFitScore %}
            <div style="text-align: center;">
                <div style="font-size: 1.5rem; font-weight: bold; color: #8b5cf6;">
                    {{ "%.0f"|format(evaluation.CulturalFitScore) }}
                </div>
                <div style="color: #6b7280; font-size: 0.875rem;">Cultural Fit</div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% if evaluation.Strengths or evaluation.key_strengths %}
    <div style="margin-bottom: 2rem;">
        <h3>‚úÖ Strengths</h3>
        <div style="background: #d1fae5; padding: 1rem; border-radius: 5px; margin-top: 0.5rem; white-space: pre-line;">
            {% if evaluation.Strengths %}
            {{ evaluation.Strengths }}
            {% elif evaluation.key_strengths %}
            {% for strength in evaluation.key_strengths %}
            ‚Ä¢ {{ strength }}
            {% endfor %}
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% if evaluation.Weaknesses or evaluation.key_risks %}
    <div style="margin-bottom: 2rem;">
        <h3>‚ö†Ô∏è Areas for Improvement</h3>
        <div style="background: #fef3c7; padding: 1rem; border-radius: 5px; margin-top: 0.5rem; white-space: pre-line;">
            {% if evaluation.Weaknesses %}
            {{ evaluation.Weaknesses }}
            {% elif evaluation.key_risks %}
            {% for risk in evaluation.key_risks %}
            ‚Ä¢ {{ risk }}
            {% endfor %}
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% if evaluation.DetailedAnalysis %}
    <div style="margin-bottom: 2rem;">
        <h3>üìù Detailed Analysis</h3>
        <div style="background: #f9fafb; padding: 1rem; border-radius: 5px; margin-top: 0.5rem; white-space: pre-line;">
            {{ evaluation.DetailedAnalysis }}
        </div>
    </div>
    {% endif %}

    {% if evaluation.Rationale %}
    <div style="margin-bottom: 2rem;">
        <h3>üìã Evaluation Rationale</h3>
        <div style="background: #dbeafe; padding: 1rem; border-radius: 5px; margin-top: 0.5rem; white-space: pre-line;">
            {{ evaluation.Rationale }}
        </div>
    </div>
    {% endif %}

    {% if evaluation.ComparisonToExcellence or evaluation.context_factors %}
    <div style="margin-bottom: 2rem;">
        <h3>üéØ Context & Factors</h3>
        <div style="background: #f5f3ff; padding: 1rem; border-radius: 5px; margin-top: 0.5rem; white-space: pre-line;">
            {% if evaluation.ComparisonToExcellence %}
            {{ evaluation.ComparisonToExcellence }}
            {% elif evaluation.context_factors %}
            {% for factor in evaluation.context_factors %}
            ‚Ä¢ {{ factor }}
            {% endfor %}
            {% endif %}
        </div>
    </div>
    {% endif %}

    <div style="font-size: 0.875rem; color: #6b7280; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
        <strong>Evaluated by:</strong> {{ evaluation.AgentName or 'AI Agent' }}<br>
        {% if evaluation.EvaluationDate %}
        <strong>Evaluation date:</strong> {{ evaluation.EvaluationDate.strftime('%Y-%m-%d %H:%M') if evaluation.EvaluationDate else 'N/A' }}<br>
        {% endif %}
        {% if evaluation.CreatedAt %}
        <strong>Created:</strong> {{ evaluation.CreatedAt.strftime('%Y-%m-%d %H:%M') if evaluation.CreatedAt else 'N/A' }}<br>
        {% endif %}
        {% if evaluation.ProcessingTimeMs %}
        <strong>Processing time:</strong> {{ evaluation.ProcessingTimeMs }}ms
        {% endif %}
    </div>
    {% else %}
    <div style="text-align: center; padding: 3rem; background: #f9fafb; border-radius: 5px;">
        <p style="color: #6b7280; margin-bottom: 1rem;">This application has not been evaluated yet.</p>
        <button class="btn btn-success" onclick="evaluateApplication()">ü§ñ Evaluate Now</button>
    </div>
    {% endif %}

    <h3 style="margin-top: 2rem;">üìÑ Application Content</h3>
    <div style="background: #f9fafb; padding: 1.5rem; border-radius: 5px; margin-top: 0.5rem; white-space: pre-line; max-height: 500px; overflow-y: auto;">
        {{ application.ApplicationText }}
    </div>
</div>

<script>
async function evaluateApplication() {
    if (!confirm('Evaluate this application with AI?')) return;
    
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = 'Evaluating...';
    
    try {
        const response = await fetch(`/evaluate/{{ application.ApplicationID }}`, { method: 'POST' });
        const data = await response.json();
        
        if (response.ok) {
            alert(`Evaluation complete!\nScore: ${data.overall_score}/100\nRecommendation: ${data.recommendation}`);
            location.reload();
        } else {
            alert(`Error: ${data.error}`);
            btn.disabled = false;
            btn.textContent = 'ü§ñ Evaluate Now';
        }
    } catch (error) {
        alert(`Error: ${error.message}`);
        btn.disabled = false;
        btn.textContent = 'ü§ñ Evaluate Now';
    }
}
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Dashboard - Application Evaluation{% endblock %}

{% block content %}
<div class="stats">
    <div class="stat-card">
        <div class="stat-value">{{ pending_count }}</div>
        <div class="stat-label">Pending Review</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ evaluated_count }}</div>
        <div class="stat-label">Evaluated</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ total_count }}</div>
        <div class="stat-label">Total Students</div>
    </div>
</div>

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2>ðŸ“‹ Recent Applications</h2>
        <div style="display: flex; gap: 1rem;">
            <a href="{{ url_for('students') }}" class="btn btn-secondary">ðŸ‘¥ View All Students</a>
            <a href="{{ url_for('upload') }}" class="btn btn-success">+ Add New Student</a>
        </div>
    </div>

    {% if applications %}
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Applicant</th>
                <th>Status</th>
                <th>Uploaded</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for app in applications %}
            <tr>
                <td>#{{ app.applicationid }}</td>
                <td>{{ app.applicantname }}</td>
                <td>
                    <span class="badge badge-{{ app.status.lower() if app.status else 'pending' }}">
                        {{ app.status or 'Pending' }}
                    </span>
                </td>
                <td>{{ app.uploadeddate.strftime('%Y-%m-%d') if app.uploadeddate else 'N/A' }}</td>
                <td>
                    <a href="{{ url_for('student_detail', application_id=app.applicationid) }}" 
                       class="btn btn-secondary" style="padding: 0.5rem 1rem;">View</a>
                    {% if app.status == 'Pending' %}
                    <a href="{{ url_for('process_student', application_id=app.applicationid) }}" 
                       class="btn btn-success" style="padding: 0.5rem 1rem;">Process</a>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div style="margin-top: 1rem; text-align: center;">
        <a href="{{ url_for('students') }}" class="btn btn-secondary">View All {{ total_count }} Students â†’</a>
    </div>
    {% else %}
    <p style="text-align: center; padding: 3rem; color: #6b7280;">
        No applications yet. <a href="{{ url_for('upload') }}">Upload your first student application</a>
    </p>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
async function evaluateOne(button) {
    if (!confirm('Evaluate this application with AI?')) return;
    
    const applicationId = button.dataset.appId;
    button.disabled = true;
    button.textContent = 'Evaluating...';
    
    try {
        const response = await fetch(`/evaluate/${applicationId}`, { method: 'POST' });
        const data = await response.json();
        
        if (response.ok) {
            alert(`Evaluation complete!\nScore: ${data.overall_score}/100\nRecommendation: ${data.recommendation}`);
            location.reload();
        } else {
            alert(`Error: ${data.error}`);
            btn.disabled = false;
            btn.textContent = 'Evaluate';
        }
    } catch (error) {
        alert(`Error: ${error.message}`);
        btn.disabled = false;
        btn.textContent = 'Evaluate';
    }
}

async function evaluateAll() {
    if (!confirm('Evaluate all pending applications? This may take a few minutes.')) return;
    
    const btn = event.target;
    btn.disabled = true;
    btn.textContent = 'Evaluating...';
    
    try {
        const response = await fetch('/evaluate_all', { method: 'POST' });
        const data = await response.json();
        
        if (response.ok) {
            alert(`Evaluated ${data.evaluations.length} applications!`);
            location.reload();
        } else {
            alert(`Error: ${data.error}`);
            btn.disabled = false;
            btn.textContent = 'ðŸ¤– Evaluate All Pending';
        }
    } catch (error) {
        alert(`Error: ${error.message}`);
        btn.disabled = false;
        btn.textContent = 'ðŸ¤– Evaluate All Pending';
    }
}
</script>
{% endblock %}

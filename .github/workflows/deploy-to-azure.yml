name: Deploy to Azure Web App

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Lint with pylint (optional)
      run: |
        pip install pylint
        # pylint src/agents/*.py --exit-zero || true
      continue-on-error: true
    
    - name: Quick validation
      env:
        DATABASE_URL: postgresql://user:pass@localhost:5432/appdb
      run: |
        python -c "import app; import src.config; print('OK App modules load successfully')"

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: Create deployment package with pre-built venv
      run: |
        # Create and build virtual environment
        python -m venv venv
        source venv/bin/activate
        pip install --upgrade pip
        pip install -r requirements.txt
        deactivate
        
        # Create deployment directory with app and pre-built venv
        mkdir -p deployment
        cp -r app.py wsgi.py startup.py src web database uploads requirements.txt deployment/ 2>/dev/null || true
        cp -r venv deployment/venv
        
        # Zip the deployment (exclude unnecessary files)
        cd deployment
        zip -r ../app.zip . \
          -x "*.git*" \
          "__pycache__/*" \
          "*.pyc" \
          "venv/lib/python3.11/site-packages/pip/*" \
          "venv/lib/python3.11/site-packages/setuptools/*" \
          "venv/lib/python3.11/site-packages/wheel/*" \
          ".DS_Store"
        cd ..
        ls -lh app.zip
        echo "âœ… Deployment package created with pre-built virtual environment"

    - name: Extract publish profile metadata
      id: publish_profile
      env:
        PUBLISH_PROFILE: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
      run: |
        python - <<'PY'
        import os
        import xml.etree.ElementTree as ET

        profile_xml = os.environ.get("PUBLISH_PROFILE", "").strip()
        if not profile_xml:
            raise SystemExit("Missing AZURE_WEBAPP_PUBLISH_PROFILE secret")

        root = ET.fromstring(profile_xml)
        publish_profile = root.find(".//publishProfile")
        if publish_profile is None:
            raise SystemExit("publishProfile element not found in profile XML")

        site_name = publish_profile.attrib.get("siteName") or ""
        slot_name = publish_profile.attrib.get("slotName") or ""
        if slot_name.lower() in {"", "production"}:
            slot_name = ""

        output_path = os.environ.get("GITHUB_OUTPUT")
        with open(output_path, "a", encoding="utf-8") as output_file:
            output_file.write(f"app_name={site_name}\n")
            output_file.write(f"slot_name={slot_name}\n")
        PY

    - name: Deploy to Azure App Service (production)
      if: steps.publish_profile.outputs.slot_name == ''
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ steps.publish_profile.outputs.app_name }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: app.zip

    - name: Deploy to Azure App Service (slot)
      if: steps.publish_profile.outputs.slot_name != ''
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ steps.publish_profile.outputs.app_name }}
        slot-name: ${{ steps.publish_profile.outputs.slot_name }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: app.zip

    - name: Enable debug logs
      if: failure()
      run: echo "Deployment failed; check publish profile/site name alignment."
    
    - name: Wait for deployment to settle
      run: |
        echo "Waiting 15 seconds for deployment to complete..."
        sleep 15
  
  notification:
    needs: [test, deploy]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Check deployment status
      run: |
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "Deployment to Azure Web App succeeded."
        else
          echo "Deployment completed with status: ${{ needs.deploy.result }}"
        fi
